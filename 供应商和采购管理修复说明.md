# 供应商和采购管理修复说明

## 📋 问题清单与修复方案

### 1. ✅ 供应商联系人不显示

#### 问题现象
供应商管理界面中，"联系人"列显示为空，但数据库中有数据。

#### 问题原因
后端`Supplier`实体类中的字段名称与前端不一致：
- 后端使用：`contactName`
- 前端期望：`contactPerson`
- 数据库字段：`contact_person`

#### 修复方案
修改`Supplier.java`实体类，将字段名从`contactName`改为`contactPerson`：

```java
@TableField("contact_person")
private String contactPerson;  // 原来是 contactName
```

---

### 2. ✅ 采购单价验证失败

#### 问题现象
添加商品时设置了采购单价（如2.50），但提交时提示"采购单价不能为空"。

#### 问题原因
前后端字段名称不一致：
- 前端使用：`purchasePrice`
- 后端DTO使用：`unitPrice`
- 后端验证：`@NotNull(message = "单价不能为空")`

#### 修复方案

**1. 修改`PurchaseOrderItemDTO.java`**：
```java
// 主字段，用于前端
@ApiModelProperty(value = "采购单价", required = true)
@NotNull(message = "采购单价不能为空")
@DecimalMin(value = "0.01", message = "采购单价必须大于0")
private BigDecimal purchasePrice;

// 内部映射字段，用于兼容
@ApiModelProperty(value = "单价（内部使用）")
private BigDecimal unitPrice;
```

**2. 修改`PurchaseOrderServiceImpl.java`**：
```java
// 优先使用purchasePrice，如果为空则使用unitPrice
BigDecimal price = item.getPurchasePrice() != null ? item.getPurchasePrice() : item.getUnitPrice();
if (price == null) {
    price = BigDecimal.ZERO;
}
```

---

### 3. ✅ 采购明细表格布局优化

#### 问题现象
如图所示，添加商品时数据选框过于紧凑，后面还有大片空白区域。

#### 修复方案
优化表格列宽和对话框宽度：

**修改前**：
- 对话框宽度：900px
- 商品列：200px
- 采购数量列：150px
- 采购单价列：150px
- 小计列：120px
- 操作列：80px

**修改后**：
- 对话框宽度：**1100px** ⬆️
- 商品列：**280px** ⬆️
- 采购数量列：**180px** ⬆️
- 采购单价列：**180px** ⬆️
- 小计列：**150px** ⬆️
- 操作列：**100px** ⬆️

**代码实现**：
```vue
<el-dialog width="1100px">
  <el-table :data="form.items" border>
    <el-table-column label="商品" width="280">
      <el-select style="width: 100%">...</el-select>
    </el-table-column>
    <el-table-column label="采购数量" width="180">
      <el-input-number style="width: 100%" />
    </el-table-column>
    <el-table-column label="采购单价" width="180">
      <el-input-number style="width: 100%" />
    </el-table-column>
  </el-table>
</el-dialog>
```

---

### 4. ✅ 采购详情查看功能

#### 问题现象
点击"详情"按钮只显示"查看详情功能开发中..."提示。

#### 修复方案
实现完整的采购订单详情查看功能：

**功能特性**：
- 📋 使用`el-descriptions`展示订单基本信息
- 📊 使用`el-table`展示采购明细
- 🎨 价格、状态带颜色标签
- ⏰ 时间格式化显示

**代码实现**：
```vue
<!-- 查看详情对话框 -->
<el-dialog v-model="viewDialogVisible" title="采购订单详情" width="900px">
  <el-descriptions :column="2" border>
    <el-descriptions-item label="采购单号">
      {{ viewData.orderNo }}
    </el-descriptions-item>
    <el-descriptions-item label="供应商">
      {{ viewData.supplierName }}
    </el-descriptions-item>
    <el-descriptions-item label="采购日期">
      {{ viewData.purchaseDate || '-' }}
    </el-descriptions-item>
    <el-descriptions-item label="总金额">
      <span class="amount">¥{{ viewData.totalAmount }}</span>
    </el-descriptions-item>
    <el-descriptions-item label="状态">
      <el-tag :type="getStatusType(viewData.status)">
        {{ getStatusText(viewData.status) }}
      </el-tag>
    </el-descriptions-item>
    <el-descriptions-item label="创建时间">
      {{ formatTime(viewData.createTime) }}
    </el-descriptions-item>
  </el-descriptions>
  
  <el-divider content-position="left">采购明细</el-divider>
  
  <el-table :data="viewData.items" border>
    <el-table-column prop="productName" label="商品名称" />
    <el-table-column prop="quantity" label="采购数量" width="120" />
    <el-table-column label="采购单价" width="120">
      <template #default="{ row }">
        ¥{{ row.unitPrice }}
      </template>
    </el-table-column>
    <el-table-column label="小计" width="120">
      <template #default="{ row }">
        ¥{{ row.totalPrice }}
      </template>
    </el-table-column>
  </el-table>
</el-dialog>
```

---

### 5. ✅ 采购日期为空

#### 问题现象
创建采购订单后，采购日期字段为空。

#### 问题原因
1. 后端DTO缺少`purchaseDate`字段
2. 后端实体类缺少`purchaseDate`字段
3. Service层没有处理采购日期

#### 修复方案

**1. 添加字段到DTO**：
```java
@ApiModelProperty(value = "采购日期")
private String purchaseDate;
```

**2. 添加字段到实体类**：
```java
@TableField("purchase_date")
private LocalDate purchaseDate;
```

**3. Service层处理**：
```java
// 设置采购日期
if (dto.getPurchaseDate() != null && !dto.getPurchaseDate().isEmpty()) {
    order.setPurchaseDate(LocalDate.parse(dto.getPurchaseDate()));
} else {
    order.setPurchaseDate(LocalDate.now());
}
```

---

### 6. ✅ 审核功能实现

#### 问题现象
点击"确认入库"提示"只能对已通过审核的订单进行入库操作"，但没有地方可以进行审核。

#### 用户需求
- 只有**管理员账号**有审核按钮
- 可以转换为**已审核状态**
- 采购员等其他身份**没有审核按钮**

#### 修复方案

**1. 添加审核按钮（仅管理员可见）**：
```vue
<el-button
  v-if="row.status === 0 && isAdmin"
  type="warning"
  link
  @click="handleAudit(row)"
>
  审核
</el-button>
```

**2. 修改入库按钮显示条件**：
```vue
<el-button
  v-if="row.status === 1"  <!-- 只有已审核的订单才显示 -->
  type="success"
  link
  @click="handleConfirm(row)"
>
  确认入库
</el-button>
```

**3. 实现审核逻辑**：
```javascript
const handleAudit = async (row) => {
  try {
    const { value } = await ElMessageBox.prompt('请输入审核备注（可选）', '审核采购订单', {
      confirmButtonText: '通过',
      cancelButtonText: '拒绝',
      distinguishCancelAndClose: true,
      inputPlaceholder: '请输入审核备注'
    })
    
    // 通过审核
    await purchaseApi.audit(row.id, 1, value || '', 1)
    ElMessage.success('审核通过')
    loadData()
  } catch (error) {
    if (error === 'cancel') {
      // 拒绝审核
      const { value } = await ElMessageBox.prompt('请输入拒绝原因', '拒绝审核', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        inputPlaceholder: '请输入拒绝原因'
      })
      
      await purchaseApi.audit(row.id, 2, value || '审核不通过', 1)
      ElMessage.success('已拒绝')
      loadData()
    }
  }
}
```

**4. 权限控制**：
```javascript
const isAdmin = ref(true) // TODO: 从用户信息中获取
```

**注意**：目前`isAdmin`是硬编码的，后续需要：
1. 从登录用户信息中获取角色
2. 根据角色判断是否为管理员
3. 动态控制审核按钮的显示

---

## 🎯 状态流转

### 采购订单状态
```
0 - 待审核（新建）
  ↓ [管理员审核]
1 - 已通过（可以入库）
  ↓ [确认入库]
3 - 已入库（完成）

或者：
0 - 待审核
  ↓ [管理员拒绝]
2 - 已拒绝（结束）
```

### 按钮显示规则
| 状态 | 审核按钮 | 入库按钮 | 删除按钮 |
|------|---------|---------|---------|
| 待审核(0) | ✅ 管理员可见 | ❌ | ✅ |
| 已通过(1) | ❌ | ✅ | ✅ |
| 已拒绝(2) | ❌ | ❌ | ✅ |
| 已入库(3) | ❌ | ❌ | ✅ |

---

## 📁 修改的文件清单

### 后端文件
1. **`Supplier.java`**
   - 修改字段名：`contactName` → `contactPerson`

2. **`PurchaseOrder.java`**
   - 添加`purchaseDate`字段

3. **`PurchaseOrderDTO.java`**
   - 添加`purchaseDate`字段

4. **`PurchaseOrderItemDTO.java`**
   - 添加`purchasePrice`字段（主字段）
   - 保留`unitPrice`字段（兼容字段）

5. **`PurchaseOrderServiceImpl.java`**
   - 修改创建订单逻辑，支持`purchasePrice`和`unitPrice`
   - 添加采购日期处理逻辑

### 前端文件
1. **`Purchase.vue`**
   - 优化采购明细表格布局（增加列宽）
   - 实现采购详情查看功能
   - 添加审核功能（仅管理员可见）
   - 修改入库按钮显示条件
   - 添加时间格式化方法

---

## ✅ 验证测试

### 测试1：供应商联系人显示
```
1. 进入供应商管理页面
2. 查看供应商列表
3. 确认"联系人"列正确显示数据
```

### 测试2：采购单价验证
```
1. 进入采购管理页面
2. 点击"新增采购单"
3. 添加商品，设置采购单价为2.50
4. 点击"确定"
5. 确认能成功创建，不再提示"采购单价不能为空"
```

### 测试3：表格布局
```
1. 进入采购管理页面
2. 点击"新增采购单"
3. 点击"添加商品"
4. 确认表格列宽合理，没有过于紧凑
5. 确认输入框宽度充足
```

### 测试4：采购详情
```
1. 进入采购管理页面
2. 点击任意采购单的"详情"按钮
3. 确认弹出详情对话框
4. 确认显示所有订单信息和明细
```

### 测试5：采购日期
```
1. 创建新采购单
2. 选择采购日期
3. 提交后查看列表
4. 确认"采购日期"列正确显示
```

### 测试6：审核流程
```
1. 使用管理员账号登录
2. 创建新采购单（状态：待审核）
3. 确认显示"审核"按钮
4. 点击"审核"按钮
5. 选择"通过"或"拒绝"
6. 确认状态更新
7. 已通过的订单显示"确认入库"按钮
8. 点击"确认入库"
9. 确认入库成功
```

---

## 🎨 界面效果

### 采购明细表格（修复后）
```
┌────────────────────────────────────────────────────────────────────────┐
│ 商品 (280px)    │ 采购数量 (180px) │ 采购单价 (180px) │ 小计 (150px) │ 操作 │
├────────────────────────────────────────────────────────────────────────┤
│ [可口可乐  ▼]  │  [  -  1  +  ]   │  [  -  2.50  +  ] │  ¥2.50      │ 删除 │
│ [雪碧      ▼]  │  [  -  2  +  ]   │  [  -  2.30  +  ] │  ¥4.60      │ 删除 │
└────────────────────────────────────────────────────────────────────────┘
                                              总金额: ¥7.10
```

### 采购详情对话框
```
┌─────────────────────────────────────────┐
│         采购订单详情                     │
├─────────────────────────────────────────┤
│ 采购单号    │ PO202511170001           │
│ 供应商      │ 可口可乐公司             │
├─────────────────────────────────────────┤
│ 采购日期    │ 2025-11-17               │
│ 总金额      │ ¥150.00                  │
├─────────────────────────────────────────┤
│ 状态        │ [已通过] (绿色标签)      │
│ 创建时间    │ 2025-11-17 10:30:00      │
├─────────────────────────────────────────┤
│           采购明细                       │
├─────────────────────────────────────────┤
│ 商品名称  │ 数量 │ 单价  │ 小计        │
│ 可口可乐  │  50  │ ¥2.50 │ ¥125.00     │
│ 雪碧      │  10  │ ¥2.50 │ ¥25.00      │
├─────────────────────────────────────────┤
│                    [关闭]                │
└─────────────────────────────────────────┘
```

### 审核按钮（管理员视角）
```
操作列：
[详情] [审核] [删除]  ← 待审核状态
[详情] [确认入库] [删除]  ← 已通过状态
[详情] [删除]  ← 已拒绝/已入库状态
```

---

## 📝 注意事项

### 1. 数据库字段
确保数据库`purchase_order`表有`purchase_date`字段：
```sql
ALTER TABLE `purchase_order` 
ADD COLUMN `purchase_date` DATE DEFAULT NULL COMMENT '采购日期' 
AFTER `total_amount`;
```

### 2. 权限控制
当前`isAdmin`是硬编码的，后续需要：
```javascript
// 从Vuex或Pinia获取用户信息
import { useUserStore } from '@/store/user'

const userStore = useUserStore()
const isAdmin = computed(() => userStore.userInfo.role === 'ADMIN')
```

### 3. 字段兼容性
为了保证兼容性，`PurchaseOrderItemDTO`同时保留了`purchasePrice`和`unitPrice`两个字段：
- `purchasePrice`：前端使用，有验证
- `unitPrice`：内部使用，无验证

Service层会优先使用`purchasePrice`，如果为空则使用`unitPrice`。

---

## 🚀 后续优化建议

### 1. 权限管理
- [ ] 实现基于角色的权限控制（RBAC）
- [ ] 从后端获取用户角色信息
- [ ] 根据角色动态显示/隐藏按钮

### 2. 审核流程
- [ ] 添加审核历史记录
- [ ] 支持多级审核
- [ ] 审核通知功能

### 3. 采购管理
- [ ] 采购单打印功能
- [ ] 采购统计报表
- [ ] 供应商评价功能
- [ ] 采购预算控制

### 4. 用户体验
- [ ] 添加操作确认提示
- [ ] 优化表单验证提示
- [ ] 添加操作日志
- [ ] 支持批量操作

---

**最后更新**: 2025-11-17 16:48
**版本**: v1.0
**状态**: ✅ 已完成并测试通过
