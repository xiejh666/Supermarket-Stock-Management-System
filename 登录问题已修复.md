# ç™»å½•é—®é¢˜å·²ä¿®å¤ âœ…

## ğŸ” é—®é¢˜åŸå› 

### 1. æ ¸å¿ƒé—®é¢˜ï¼šç¼ºå°‘ Spring Security é…ç½®

**ç—‡çŠ¶**ï¼š
- è¯·æ±‚æ–¹æ³•ï¼š`OPTIONS`ï¼ˆCORS é¢„æ£€è¯·æ±‚ï¼‰
- çŠ¶æ€ç ï¼š`401 Unauthorized`
- URLï¼š`http://localhost:8080/api/login`

**åŸå› **ï¼š
- Spring Security é»˜è®¤æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ OPTIONS é¢„æ£€è¯·æ±‚
- æ²¡æœ‰é…ç½® CORSï¼Œå¯¼è‡´æµè§ˆå™¨æ— æ³•å‘é€è·¨åŸŸè¯·æ±‚
- ç¼ºå°‘ `SecurityConfig.java` é…ç½®æ–‡ä»¶

---

## ğŸ› ï¸ å·²ä¿®å¤å†…å®¹

### 1. åˆ›å»º SecurityConfig.java âœ…

**æ–‡ä»¶è·¯å¾„**ï¼š
```
supermarket-backend/src/main/java/com/supermarket/config/SecurityConfig.java
```

**ä¸»è¦åŠŸèƒ½**ï¼š
- âœ… ç¦ç”¨ CSRFï¼ˆä½¿ç”¨ JWT ä¸éœ€è¦ï¼‰
- âœ… é…ç½® CORSï¼ˆå…è®¸è·¨åŸŸï¼‰
- âœ… å…è®¸ OPTIONS é¢„æ£€è¯·æ±‚
- âœ… æ”¾è¡Œç™»å½•æ¥å£ï¼ˆ`/auth/login`ï¼‰
- âœ… æ”¾è¡Œ Swagger æ–‡æ¡£æ¥å£
- âœ… é…ç½®æ— çŠ¶æ€ä¼šè¯ï¼ˆJWT è®¤è¯ï¼‰

**å…³é”®é…ç½®**ï¼š
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .csrf().disable()  // ç¦ç”¨ CSRF
        .cors().and()      // å¯ç”¨ CORS
        .sessionManagement()
        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        .and()
        .authorizeRequests()
        .antMatchers("/auth/login", "/auth/register").permitAll()  // ç™»å½•æ¥å£æ— éœ€è®¤è¯
        .antMatchers("/swagger-ui/**", "/doc.html", ...).permitAll()  // Swagger æ— éœ€è®¤è¯
        .anyRequest().authenticated();  // å…¶ä»–æ¥å£éœ€è¦è®¤è¯
}

@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.setAllowedOriginPatterns(Arrays.asList("*"));
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
    configuration.setAllowedHeaders(Arrays.asList("*"));
    configuration.setAllowCredentials(true);
    // ...
}
```

### 2. ä¼˜åŒ–å‰ç«¯é”™è¯¯å¤„ç† âœ…

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ˆ`console.error`ï¼‰
- âœ… æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
- âœ… ä¿®å¤ userInfo å­˜å‚¨ï¼ˆä» `res.data.userInfo` æ”¹ä¸º `res.data`ï¼‰

---

## ğŸš€ ç°åœ¨éœ€è¦åšçš„

### æ­¥éª¤ 1ï¼šé‡å¯åç«¯ âš ï¸

**é‡è¦**ï¼šSecurityConfig åªæœ‰åœ¨é‡å¯åç«¯åæ‰ä¼šç”Ÿæ•ˆï¼

#### æ–¹æ³•ä¸€ï¼šåœ¨ IDEA ä¸­é‡å¯
1. åœæ­¢æ­£åœ¨è¿è¡Œçš„åç«¯
2. é‡æ–°è¿è¡Œ `SupermarketApplication.java`

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ Maven å‘½ä»¤
```bash
# åœæ­¢åç«¯ï¼ˆCtrl+Cï¼‰
cd supermarket-backend
mvn spring-boot:run
```

### æ­¥éª¤ 2ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

```bash
# æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
# å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’® â†’ é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"
```

### æ­¥éª¤ 3ï¼šé‡æ–°æµ‹è¯•ç™»å½•

1. è®¿é—®ï¼šhttp://localhost:3000
2. è¾“å…¥ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`123456`
3. ç‚¹å‡»"ç™»å½•"

---

## âœ… éªŒè¯ä¿®å¤æˆåŠŸçš„æ ‡å¿—

### 1. åç«¯æ—¥å¿—æ£€æŸ¥

å¯åŠ¨ååº”è¯¥çœ‹åˆ°ï¼š
```
INFO  o.s.security.web.DefaultSecurityFilterChain - Will secure any request with [...]
INFO  o.s.b.w.embedded.tomcat.TomcatWebServer - Tomcat started on port(s): 8080
```

### 2. æµè§ˆå™¨ Network æ£€æŸ¥

æŒ‰ F12 â†’ Network æ ‡ç­¾ï¼Œç™»å½•æ—¶åº”è¯¥çœ‹åˆ°ï¼š

**OPTIONS é¢„æ£€è¯·æ±‚**ï¼š
```
Request URL: http://localhost:8080/api/auth/login
Request Method: OPTIONS
Status Code: 200 OK  âœ…ï¼ˆä¸å†æ˜¯ 401ï¼‰
```

**POST ç™»å½•è¯·æ±‚**ï¼š
```
Request URL: http://localhost:8080/api/auth/login
Request Method: POST
Status Code: 200 OK  âœ…
Response: {
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGc...",
    "userId": 1,
    "username": "admin",
    ...
  }
}
```

### 3. ç™»å½•æˆåŠŸ

- âœ… é¡µé¢è‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µï¼ˆ`/dashboard`ï¼‰
- âœ… é¡¶éƒ¨æ˜¾ç¤ºç”¨æˆ·å"ç®¡ç†å‘˜"
- âœ… å·¦ä¾§æ˜¾ç¤ºèœå•æ 
- âœ… èƒ½çœ‹åˆ°æ•°æ®ç»Ÿè®¡å¡ç‰‡å’Œå›¾è¡¨

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### ä»€ä¹ˆæ˜¯ OPTIONS é¢„æ£€è¯·æ±‚ï¼Ÿ

å½“æµè§ˆå™¨å‘é€è·¨åŸŸè¯·æ±‚æ—¶ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ª OPTIONS è¯·æ±‚ï¼ˆé¢„æ£€è¯·æ±‚ï¼‰æ¥è¯¢é—®æœåŠ¡å™¨ï¼š
- æ˜¯å¦å…è®¸è·¨åŸŸï¼Ÿ
- å…è®¸å“ªäº› HTTP æ–¹æ³•ï¼Ÿ
- å…è®¸å“ªäº›è¯·æ±‚å¤´ï¼Ÿ

åªæœ‰é¢„æ£€é€šè¿‡ï¼ˆè¿”å› 200ï¼‰ï¼Œæµè§ˆå™¨æ‰ä¼šå‘é€çœŸæ­£çš„ POST/GET ç­‰è¯·æ±‚ã€‚

### ä¸ºä»€ä¹ˆä¹‹å‰è¿”å› 401ï¼Ÿ

å› ä¸º Spring Security é»˜è®¤ä¼šæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ OPTIONSï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼š
```java
.antMatchers("/auth/login").permitAll()
```

Spring Security ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªéœ€è¦è®¤è¯çš„è¯·æ±‚ï¼Œè¿”å› 401ã€‚

### CORS é…ç½®çš„ä½œç”¨

```java
configuration.setAllowedOriginPatterns(Arrays.asList("*"));  // å…è®¸æ‰€æœ‰æº
configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));  // å…è®¸çš„æ–¹æ³•
configuration.setAllowedHeaders(Arrays.asList("*"));  // å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
configuration.setAllowCredentials(true);  // å…è®¸æºå¸¦è®¤è¯ä¿¡æ¯ï¼ˆCookieã€Tokenï¼‰
```

è¿™æ ·æµè§ˆå™¨å°±èƒ½æˆåŠŸå‘é€è·¨åŸŸè¯·æ±‚ã€‚

---

## ğŸ”§ å¦‚æœè¿˜æ˜¯ä¸è¡Œ

### 1. ç¡®è®¤åç«¯å·²é‡å¯

æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰æ–°çš„å¯åŠ¨æ—¥å¿—ã€‚

### 2. æ£€æŸ¥ SecurityConfig æ˜¯å¦è¢«åŠ è½½

åœ¨åç«¯æ—¥å¿—ä¸­æœç´¢ï¼š
```
DefaultSecurityFilterChain
```

åº”è¯¥èƒ½çœ‹åˆ°ç›¸å…³æ—¥å¿—ã€‚

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

æœ‰æ—¶æµè§ˆå™¨ä¼šç¼“å­˜ OPTIONS è¯·æ±‚çš„å“åº”ã€‚

### 4. ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•

Chrome â†’ Ctrl+Shift+N æ‰“å¼€æ— ç—•çª—å£ï¼Œè®¿é—® http://localhost:3000 æµ‹è¯•ã€‚

### 5. æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

æŒ‰ F12 â†’ Console æ ‡ç­¾ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Spring Security CORS é…ç½®](https://docs.spring.io/spring-security/reference/servlet/integrations/cors.html)
- [MDN - CORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)
- [JWT è®¤è¯æµç¨‹](https://jwt.io/introduction)

---

## ğŸ‰ æ€»ç»“

**é—®é¢˜**ï¼šSpring Security æ‹¦æˆªäº† CORS é¢„æ£€è¯·æ±‚

**è§£å†³**ï¼š
1. åˆ›å»º `SecurityConfig.java`
2. é…ç½® CORS
3. æ”¾è¡Œç™»å½•æ¥å£
4. é‡å¯åç«¯

**ç°åœ¨è¯·é‡å¯åç«¯ï¼Œç„¶åæµ‹è¯•ç™»å½•ï¼** ğŸš€

---

## ğŸ” å…¶ä»–å¯èƒ½çš„é—®é¢˜

å¦‚æœç™»å½•è¿˜æ˜¯å¤±è´¥ï¼Œæ£€æŸ¥ï¼š

### 1. æ•°æ®åº“é—®é¢˜
```sql
USE supermarket_db;
SELECT * FROM sys_user WHERE username = 'admin';
```

### 2. å¯†ç åŠ å¯†é—®é¢˜

å¯†ç åº”è¯¥æ˜¯ BCrypt åŠ å¯†çš„ï¼š
```
$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iwK8pDPW
```

### 3. ç«¯å£å†²çª

ç¡®è®¤ï¼š
- åç«¯ï¼šhttp://localhost:8080/api/doc.html èƒ½è®¿é—®
- å‰ç«¯ï¼šhttp://localhost:3000 èƒ½è®¿é—®

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** è¯·æä¾›ï¼š
1. åç«¯å¯åŠ¨æ—¥å¿—
2. æµè§ˆå™¨ Console é”™è¯¯
3. Network ä¸­çš„è¯·æ±‚è¯¦æƒ…

ç¥æ‚¨ç™»å½•æˆåŠŸï¼ğŸŠ


