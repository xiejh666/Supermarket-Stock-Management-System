# 商品编码查询功能实现总结

**完成日期：** 2025-12-09  
**功能描述：** 为消息通知添加商品编码字段，实现基于商品编码的精确查询

---

## 实现背景

用户反馈：商品名称可能相同（只是规格或价格不同），使用商品名称查询不够严谨。建议使用商品编码进行精确查询。

## 实现方案

### 1. 数据库层面 ✅

**修改表结构：** `system_notification` 表添加 `related_code` 字段

```sql
ALTER TABLE system_notification 
ADD COLUMN related_code VARCHAR(100) 
COMMENT '关联编码（如商品编码、订单号等）' 
AFTER business_type;
```

**字段说明：**
- `related_code`：存储关联的编码信息
  - 商品通知：存储商品编码
  - 订单通知：可以存储订单号
  - 其他通知：根据业务需要存储相应编码

---

### 2. 后端实现 ✅

#### 2.1 实体类修改

**文件：** `SystemNotification.java`

```java
/**
 * 关联编码（如商品编码、订单号等）
 */
private String relatedCode;
```

#### 2.2 服务接口修改

**文件：** `BusinessOperationNotificationService.java`

```java
/**
 * 商品操作通知
 * @param operatorId 操作人ID
 * @param operatorRole 操作人角色
 * @param operation 操作类型：CREATE, UPDATE, DELETE
 * @param productName 商品名称
 * @param productCode 商品编码
 * @param productId 商品ID
 */
void notifyProductOperation(Long operatorId, String operatorRole, String operation, 
                           String productName, String productCode, Long productId);
```

#### 2.3 服务实现修改

**文件：** `BusinessOperationNotificationServiceImpl.java`

**主要修改：**

1. **修改 `notifyProductOperation` 方法**
   - 添加 `productCode` 参数
   - 在通知内容中显示商品编码
   - 将商品编码存储到 `relatedCode` 字段

```java
@Override
public void notifyProductOperation(Long operatorId, String operatorRole, String operation, 
                                   String productName, String productCode, Long productId) {
    log.info("商品操作通知：操作人ID={}, 角色={}, 操作={}, 商品名称={}, 商品编码={}", 
             operatorId, operatorRole, operation, productName, productCode);
    
    String operatorName = getUserName(operatorId);
    String title = getProductOperationTitle(operation);
    String content = String.format("%s %s %s了商品：%s（编码：%s）", 
            getRoleDisplayName(operatorRole), operatorName, 
            getOperationDisplayName(operation), productName, productCode);
    
    notifyByRole(operatorRole, operatorId, title, content, "PRODUCT_OPERATION", 
                productId, "PRODUCT", productCode);
}
```

2. **修改 `notifyByRole` 方法**
   - 添加 `relatedCode` 参数
   - 提供重载方法保持向后兼容

```java
private void notifyByRole(String operatorRole, Long operatorId, String title, 
                         String content, String type, Long businessId, 
                         String businessType, String relatedCode) {
    // ... 分发逻辑
}

// 兼容旧方法（不传relatedCode）
private void notifyByRole(String operatorRole, Long operatorId, String title, 
                         String content, String type, Long businessId, String businessType) {
    notifyByRole(operatorRole, operatorId, title, content, type, businessId, businessType, null);
}
```

3. **修改 `notifyUsersByRole` 方法**
   - 添加 `relatedCode` 参数
   - 在创建通知时设置 `relatedCode`

```java
notification.setRelatedCode(relatedCode);
```

#### 2.4 调用处修改

**文件：** `ProductServiceImpl.java`

所有调用 `notifyProductOperation` 的地方都添加商品编码参数：

```java
// 创建商品
businessNotificationService.notifyProductOperation(
    operatorId, operatorRole, "CREATE", 
    product.getProductName(), product.getProductCode(), product.getId()
);

// 更新商品
businessNotificationService.notifyProductOperation(
    operatorId, operatorRole, "UPDATE", 
    product.getProductName(), product.getProductCode(), product.getId()
);

// 删除商品
businessNotificationService.notifyProductOperation(
    operatorId, operatorRole, "DELETE", 
    product.getProductName(), product.getProductCode(), product.getId()
);

// 更新状态
businessNotificationService.notifyProductOperation(
    operatorId, operatorRole, operation, 
    product.getProductName(), product.getProductCode(), product.getId()
);
```

---

### 3. 前端实现 ✅

#### 3.1 商品管理页面

**文件：** `Product.vue`

商品管理已有商品编码搜索功能，无需修改。

**查询表单：**
```javascript
const queryForm = reactive({
  productName: '',
  productCode: '',  // 已有
  categoryId: null,
  status: null
})
```

**路由参数应用：**
```javascript
const applyRouteParams = () => {
  if (route.query.productName) {
    queryForm.productName = route.query.productName
  }
  if (route.query.productCode) {
    queryForm.productCode = route.query.productCode
  }
}
```

#### 3.2 消息通知跳转逻辑

**文件：** `Layout.vue`

修改商品跳转逻辑，使用 `relatedCode`（商品编码）：

```javascript
'PRODUCT': {
  path: '/product',
  query: { productCode: notification.relatedCode || '' }, // 使用商品编码查询
  message: '已跳转到商品管理页面'
}
```

---

## 修改文件清单

### 后端文件（5个）
1. `SystemNotification.java` - 添加 `relatedCode` 字段
2. `BusinessOperationNotificationService.java` - 修改接口方法签名
3. `BusinessOperationNotificationServiceImpl.java` - 实现新逻辑
4. `ProductServiceImpl.java` - 修改所有调用处
5. `add_related_code_to_notification.sql` - 数据库迁移脚本

### 前端文件（1个）
1. `Layout.vue` - 修改跳转逻辑使用商品编码

---

## 数据库迁移步骤

### 方式1：手动执行SQL

```sql
-- 1. 添加字段
ALTER TABLE system_notification 
ADD COLUMN related_code VARCHAR(100) 
COMMENT '关联编码（如商品编码、订单号等）' 
AFTER business_type;

-- 2. （可选）为已有商品通知补充商品编码
UPDATE system_notification sn
INNER JOIN product p ON sn.business_id = p.id
SET sn.related_code = p.product_code
WHERE sn.business_type = 'PRODUCT' AND sn.related_code IS NULL;
```

### 方式2：使用Flyway/Liquibase

将 SQL 文件放在迁移目录中，重启应用自动执行。

---

## 测试步骤

### 1. 数据库测试
```sql
-- 检查字段是否添加成功
DESC system_notification;

-- 查看商品通知的 related_code
SELECT id, title, content, business_type, related_code 
FROM system_notification 
WHERE business_type = 'PRODUCT' 
ORDER BY create_time DESC 
LIMIT 10;
```

### 2. 后端测试
1. 创建一个新商品
2. 检查日志，确认商品编码已记录
3. 查询数据库，确认 `related_code` 字段有值

### 3. 前端测试
1. 创建一个新商品（例如：商品名称="可口可乐"，商品编码="KKKL001"）
2. 查看消息通知列表
3. 点击该商品的通知
4. 验证：
   - ✅ 跳转到商品管理页面
   - ✅ 商品编码输入框自动填充 "KKKL001"
   - ✅ 查询结果只显示该商品
   - ✅ 即使有同名商品也能精确定位

### 4. 边界测试
1. 创建两个同名但编码不同的商品
   - 商品A：名称="可口可乐"，编码="KKKL001"
   - 商品B：名称="可口可乐"，编码="KKKL002"
2. 分别点击两个商品的通知
3. 验证能够精确定位到对应商品

---

## 通知内容格式变化

### 修改前
```
管理员 张三 创建了商品：可口可乐
```

### 修改后
```
管理员 张三 创建了商品：可口可乐（编码：KKKL001）
```

**优点：**
- 通知内容更加详细
- 用户可以直接看到商品编码
- 便于识别和区分同名商品

---

## 扩展性

`relatedCode` 字段设计为通用字段，未来可以用于：

1. **商品管理** - 存储商品编码 ✅
2. **订单管理** - 存储订单号
3. **供应商管理** - 存储供应商编码
4. **客户管理** - 存储客户编号
5. **其他业务** - 根据需要存储相应编码

---

## 注意事项

### 1. 数据一致性
- 新创建的通知会自动填充 `relatedCode`
- 历史通知的 `relatedCode` 为空，需要手动补充（可选）

### 2. 向后兼容
- 提供了重载方法，不传 `relatedCode` 时默认为 `null`
- 前端跳转时使用 `notification.relatedCode || ''`，避免空值错误

### 3. 性能考虑
- `related_code` 字段建议添加索引（如果查询频繁）
```sql
CREATE INDEX idx_related_code ON system_notification(related_code);
```

---

## 总结

通过添加 `relatedCode` 字段，实现了基于商品编码的精确查询功能：

1. ✅ **数据库层面** - 添加 `related_code` 字段
2. ✅ **后端层面** - 修改通知服务，存储商品编码
3. ✅ **前端层面** - 使用商品编码进行精确查询
4. ✅ **用户体验** - 解决同名商品查询不准确的问题

**核心优势：**
- 🎯 **精确定位** - 使用唯一编码，避免同名商品混淆
- 🔒 **数据严谨** - 商品编码是唯一标识，查询结果准确
- 📈 **可扩展** - `relatedCode` 字段可用于其他业务场景
- 🔄 **向后兼容** - 不影响现有功能，平滑升级

**完成时间：** 2025-12-09 16:00
