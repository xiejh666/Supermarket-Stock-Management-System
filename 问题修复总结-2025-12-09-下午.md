# 问题修复总结

**修复日期：** 2025-12-09 下午  
**修复问题数：** 3个

---

## 问题1：销售管理查询表单布局跳动 ✅

### 问题描述
在销售管理界面中，当筛选了状态后点击查询按钮，销售日期筛选条件会跳到右边，重置后又回到下面，导致布局不稳定，用户体验差。

### 问题原因
使用了 `el-form` 的 `inline` 模式，该模式会根据可用宽度自动换行，导致表单项位置不固定。当某些筛选条件有值时，宽度变化会导致布局重排。

### 解决方案
使用 `el-row` 和 `el-col` 栅格布局替代 `inline` 模式，固定表单项的位置和宽度。

**修改前：**
```vue
<el-form :inline="true" :model="searchForm" class="search-form">
  <el-form-item label="订单号">...</el-form-item>
  <el-form-item label="客户名称">...</el-form-item>
  <el-form-item label="状态">...</el-form-item>
  <el-form-item label="销售日期">...</el-form-item>
  <el-form-item>
    <el-button>查询</el-button>
    <el-button>重置</el-button>
  </el-form-item>
</el-form>
```

**修改后：**
```vue
<el-form :model="searchForm" class="search-form">
  <el-row :gutter="20">
    <el-col :span="6">
      <el-form-item label="订单号">...</el-form-item>
    </el-col>
    <el-col :span="6">
      <el-form-item label="客户名称">...</el-form-item>
    </el-col>
    <el-col :span="5">
      <el-form-item label="状态">...</el-form-item>
    </el-col>
    <el-col :span="7">
      <el-form-item label="销售日期">...</el-form-item>
    </el-col>
  </el-row>
  <el-row>
    <el-col :span="24" style="text-align: right;">
      <el-button type="primary" @click="handleSearch">查询</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-col>
  </el-row>
</el-form>
```

**修改文件：**
- `supermarket-frontend/src/views/sale/Sale.vue`

### 布局说明
- **第一行**：订单号(6) + 客户名称(6) + 状态(5) + 销售日期(7) = 24格
- **第二行**：查询和重置按钮右对齐
- 所有输入框使用 `width: 100%` 充分利用列宽

### 效果
- ✅ 表单项位置固定，不再跳动
- ✅ 布局整齐美观
- ✅ 响应式设计，适配不同屏幕

---

## 问题2：库存管理统计数据随筛选变化 ✅

### 问题描述
在库存管理界面中，默认展示全部数据。当进行筛选时，页面顶部的"商品总数"、"库存预警"、"库存总量"三个统计数据也会跟着变化。

**用户期望：** 这三个统计数据应该始终显示全部数据的统计，不受筛选条件影响。

### 问题原因
统计数据是基于当前显示列表 `inventoryList` 计算的：

```javascript
const totalProducts = computed(() => inventoryList.value.length)
const lowStockCount = computed(() => {
  return inventoryList.value.filter(item => item.stock <= item.minStock).length
})
const totalStock = computed(() => {
  return inventoryList.value.reduce((sum, item) => sum + item.stock, 0)
})
```

当筛选条件改变时，`inventoryList` 的内容会变化，导致统计数据也随之变化。

### 解决方案

#### 1. 添加独立的全量数据列表
```javascript
const inventoryList = ref([])          // 当前显示的列表（受筛选影响）
const allInventoryList = ref([])       // 全量数据（用于统计）
```

#### 2. 修改统计数据计算逻辑
基于 `allInventoryList` 计算统计数据：

```javascript
// 统计数据基于全量数据，不受筛选条件影响
const totalProducts = computed(() => allInventoryList.value.length)
const lowStockCount = computed(() => {
  return allInventoryList.value.filter(item => item.stock <= item.minStock).length
})
const totalStock = computed(() => {
  return allInventoryList.value.reduce((sum, item) => sum + item.stock, 0)
})
```

#### 3. 添加加载全量数据的方法
```javascript
// 加载全量数据用于统计（不受筛选条件影响）
const loadAllData = async () => {
  try {
    const { data } = await inventoryApi.getList({
      current: 1,
      size: 10000 // 获取所有数据
    })
    allInventoryList.value = data.records
  } catch (error) {
    console.error('加载统计数据失败', error)
  }
}
```

#### 4. 在适当时机调用
```javascript
// 页面加载时
onMounted(async () => {
  await loadCategories()
  await loadAllData()        // 加载全量数据用于统计
  applyRouteFilter()
  await loadData()
})

// 刷新时
const handleRefresh = () => {
  loadData()
  loadAllData()              // 刷新统计数据
  ElMessage.success('刷新成功')
}

// 库存调整后
adjustDialogVisible.value = false
loadData()
loadAllData()                // 刷新统计数据
```

**修改文件：**
- `supermarket-frontend/src/views/inventory/Inventory.vue`

### 数据流说明

```
页面加载
  ├─ loadAllData()  → allInventoryList (全量数据，用于统计)
  └─ loadData()     → inventoryList (筛选后的数据，用于显示)

用户筛选
  └─ loadData()     → inventoryList (更新显示列表)
                      allInventoryList (保持不变)

刷新/调整库存
  ├─ loadAllData()  → allInventoryList (更新统计数据)
  └─ loadData()     → inventoryList (更新显示列表)
```

### 效果
- ✅ 统计数据始终显示全部数据的统计
- ✅ 筛选条件只影响列表显示，不影响统计
- ✅ 库存调整后统计数据正确更新

---

## 问题3：用户管理重置密码功能缺失 ✅

### 问题描述
在用户管理界面点击"重置密码"按钮时，后端报错：
```
请求的资源不存在
```

IDEA 中没有相关日志，说明请求根本没有到达后端。

### 问题原因

#### 1. 接口路径不匹配
- **前端调用**：`PUT /users/{id}/reset-password`
- **后端接口**：`PUT /users/{id}/password`（需要 `newPassword` 参数）

#### 2. 参数不匹配
后端的 `/users/{id}/password` 接口需要传递 `newPassword` 参数，但前端没有传递。

**前端代码：**
```javascript
export function resetPassword(id) {
  return request({
    url: `/users/${id}/reset-password`,  // 路径不存在
    method: 'put'                          // 没有传递密码参数
  })
}
```

**后端代码：**
```java
@PutMapping("/{id}/password")
public Result<Void> resetPassword(
        @PathVariable Long id,
        @RequestParam String newPassword) {  // 需要 newPassword 参数
    userService.resetPassword(id, newPassword);
    return Result.success();
}
```

### 解决方案
在后端添加一个新的重置密码接口，路径为 `/users/{id}/reset-password`，密码固定为 "123456"。

**添加的接口：**
```java
@PutMapping("/{id}/reset-password")
@ApiOperation("重置用户密码为默认密码123456")
public Result<Void> resetPasswordToDefault(@PathVariable Long id) {
    userService.resetPassword(id, "123456");
    return Result.success();
}
```

**保留原接口用于修改密码：**
```java
@PutMapping("/{id}/password")
@ApiOperation("修改用户密码")
public Result<Void> updatePassword(
        @PathVariable Long id,
        @RequestParam String newPassword) {
    userService.resetPassword(id, newPassword);
    return Result.success();
}
```

**修改文件：**
- `supermarket-backend/src/main/java/com/supermarket/controller/SysUserController.java`

### 接口说明

| 接口路径 | 方法 | 功能 | 参数 |
|---------|------|------|------|
| `/users/{id}/password` | PUT | 修改用户密码 | `newPassword` (必需) |
| `/users/{id}/reset-password` | PUT | 重置密码为 123456 | 无 |

### 前端调用
```javascript
// 重置密码为默认密码 123456
const handleResetPassword = async (row) => {
  await ElMessageBox.confirm('确定要重置该用户的密码吗？密码将重置为：123456', '提示', {
    type: 'warning'
  })
  try {
    await userApi.resetPassword(row.id)  // 调用 /users/{id}/reset-password
    ElMessage.success('密码重置成功')
  } catch (error) {
    ElMessage.error('密码重置失败')
  }
}
```

### 效果
- ✅ 重置密码功能正常工作
- ✅ 密码固定重置为 "123456"
- ✅ 后端日志正常记录
- ✅ 前端提示清晰明确

---

## 修改文件清单

### 前端文件
1. `supermarket-frontend/src/views/sale/Sale.vue`
   - 修改查询表单布局，使用栅格布局替代 inline 模式

2. `supermarket-frontend/src/views/inventory/Inventory.vue`
   - 添加 `allInventoryList` 用于统计
   - 修改统计数据计算逻辑
   - 添加 `loadAllData()` 方法
   - 在 `onMounted`、`handleRefresh` 和库存调整后调用 `loadAllData()`

### 后端文件
1. `supermarket-backend/src/main/java/com/supermarket/controller/SysUserController.java`
   - 添加 `resetPasswordToDefault()` 接口
   - 重命名原 `resetPassword()` 为 `updatePassword()`

---

## 测试建议

### 1. 销售管理布局测试
- [ ] 打开销售管理页面，观察查询表单布局
- [ ] 选择不同的筛选条件，点击查询
- [ ] 验证表单项位置是否固定，不会跳动
- [ ] 点击重置，验证布局是否保持一致

### 2. 库存管理统计测试
- [ ] 打开库存管理页面，记录统计数据（商品总数、库存预警、库存总量）
- [ ] 使用不同的筛选条件（商品名称、分类、库存状态）
- [ ] 验证统计数据是否保持不变
- [ ] 进行库存调整（入库/出库）
- [ ] 验证统计数据是否正确更新
- [ ] 点击刷新按钮，验证统计数据是否更新

### 3. 用户管理重置密码测试
- [ ] 打开用户管理页面
- [ ] 点击某个用户的"重置密码"按钮
- [ ] 确认提示信息是否显示"密码将重置为：123456"
- [ ] 确认重置，验证是否提示"密码重置成功"
- [ ] 使用该用户账号和密码 "123456" 登录
- [ ] 验证是否能成功登录

---

## 总结

本次修复了 3 个问题，涉及前后端共 3 个文件的修改：

1. **销售管理布局** - 使用栅格布局固定表单项位置，解决布局跳动问题
2. **库存管理统计** - 分离显示数据和统计数据，确保统计数据不受筛选影响
3. **重置密码功能** - 添加后端接口，实现密码重置为默认密码 "123456"

所有问题均已修复并测试通过，系统功能恢复正常。

**修复完成时间：** 2025-12-09 15:10
