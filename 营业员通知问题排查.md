# 🔍 营业员通知问题排查

## ❌ 发现的问题

营业员没有收到供应商管理和客户管理的通知，但采购员正常收到。

## 🔍 可能的原因

### **1. 营业员用户不存在**
数据库中可能没有角色ID为4的营业员用户。

### **2. 营业员用户被禁用**
营业员用户存在但status=0（被禁用）。

### **3. 角色ID不匹配**
营业员的实际角色ID不是4。

---

## 🧪 排查步骤

### **第一步：检查营业员用户**
请在数据库中执行以下查询：

```sql
-- 检查所有用户的角色信息
SELECT id, username, real_name, role_id, status 
FROM sys_user 
ORDER BY role_id;

-- 专门检查营业员用户
SELECT id, username, real_name, role_id, status 
FROM sys_user 
WHERE role_id = 4;

-- 检查所有角色定义
SELECT * FROM sys_role ORDER BY id;
```

### **第二步：检查后端日志**
在后端日志中查找以下信息：
```
开始查询角色ID为 4 的用户
找到 X 个角色ID为 4 的用户
```

如果显示"找到 0 个角色ID为 4 的用户"，说明没有营业员用户。

### **第三步：检查通知记录**
```sql
-- 检查最近的通知记录
SELECT n.*, u.real_name as receiver_name, u.role_id
FROM system_notification n
LEFT JOIN sys_user u ON n.receiver_id = u.id
WHERE n.type IN ('SUPPLIER_OPERATION', 'CUSTOMER_OPERATION')
ORDER BY n.create_time DESC
LIMIT 10;
```

---

## 🛠️ 解决方案

### **方案1：如果营业员用户不存在**
创建营业员用户：
```sql
INSERT INTO sys_user (username, password, real_name, role_id, status, create_time, update_time) 
VALUES ('cashier', '$2a$10$encrypted_password', '营业员', 4, 1, NOW(), NOW());
```

### **方案2：如果营业员用户被禁用**
启用营业员用户：
```sql
UPDATE sys_user SET status = 1 WHERE role_id = 4;
```

### **方案3：如果角色ID不匹配**
检查营业员的实际角色ID，然后修改代码中的角色ID映射。

### **方案4：如果角色定义有问题**
检查sys_role表，确保有ID为4的营业员角色：
```sql
-- 如果没有营业员角色，创建一个
INSERT INTO sys_role (id, role_name, role_code, description, create_time, update_time)
VALUES (4, '营业员', 'CASHIER', '营业员角色', NOW(), NOW());
```

---

## 🔧 临时调试方案

为了快速验证问题，我可以修改通知服务，添加更详细的日志输出：

### **增强日志输出**
在通知发送时，详细记录每个角色的查询结果：

```java
// 在 BusinessOperationNotificationServiceImpl 中
private void notifyUsersByRole(Long roleId, Long senderId, String title, String content, String type, Long businessId, String businessType) {
    log.info("=== 开始查询角色ID为 {} 的用户 ===", roleId);
    
    List<SysUser> users = userMapper.selectList(
        new LambdaQueryWrapper<SysUser>()
            .eq(SysUser::getRoleId, roleId)
            .eq(SysUser::getStatus, 1)
    );
    
    log.info("=== 查询结果：找到 {} 个角色ID为 {} 的启用用户 ===", users.size(), roleId);
    
    if (users.isEmpty()) {
        log.warn("=== 警告：没有找到角色ID为 {} 的启用用户！ ===", roleId);
        
        // 额外查询：检查是否有被禁用的用户
        List<SysUser> disabledUsers = userMapper.selectList(
            new LambdaQueryWrapper<SysUser>()
                .eq(SysUser::getRoleId, roleId)
                .eq(SysUser::getStatus, 0)
        );
        log.info("=== 发现 {} 个角色ID为 {} 的被禁用用户 ===", disabledUsers.size(), roleId);
        
        return;
    }
    
    // 详细记录每个用户
    for (SysUser user : users) {
        log.info("=== 找到用户：ID={}, 用户名={}, 姓名={}, 角色ID={}, 状态={} ===", 
                user.getId(), user.getUsername(), user.getRealName(), user.getRoleId(), user.getStatus());
    }
    
    // ... 发送通知的代码
}
```

---

## 📝 请提供以下信息

为了准确定位问题，请提供：

1. **数据库查询结果**：
   ```sql
   SELECT id, username, real_name, role_id, status FROM sys_user ORDER BY role_id;
   ```

2. **后端日志片段**：
   查找包含"开始查询角色ID为 4 的用户"的日志

3. **角色定义**：
   ```sql
   SELECT * FROM sys_role ORDER BY id;
   ```

---

## 🎯 预期结果

正常情况下应该看到：
- 数据库中有角色ID为4的启用营业员用户
- 后端日志显示"找到 1 个角色ID为 4 的用户"
- 营业员收到通知

**请先检查数据库中的用户和角色信息，然后告诉我结果，我会根据具体情况提供解决方案！** 🔍
