# 🔍 通知问题深度调试指南

## 🚨 当前问题
管理员仍然没有收到采购员创建采购订单的通知。

## 🛠️ 已添加的调试功能

### **1. 增强日志输出**
我已经在关键位置添加了详细的调试日志：

#### **采购订单创建日志**
```
=== 开始创建采购订单 ===
申请人ID: X, 供应商ID: X, 订单项数量: X
=== 开始发送采购订单创建通知 ===
订单ID: X, 申请人ID: X, 订单号: XXX, 金额: XXX
申请人角色: PURCHASER
=== 采购订单创建通知发送完成 ===
=== 采购订单创建流程结束 ===
```

#### **通知发送详细日志**
```
开始查询角色ID为 1 的用户
找到 X 个角色ID为 1 的用户
找到用户：ID=X, 姓名=XXX, 角色ID=1, 状态=1
业务操作通知发送结果：接收人=XXX, 保存成功=true, 通知ID=XXX
```

### **2. 测试接口**
创建了测试控制器 `TestNotificationController`：
```
POST /test/notification?operatorId=2&operatorRole=PURCHASER
```

---

## 🧪 调试步骤

### **第一步：重启后端服务** ⚠️
必须重启以加载新的调试代码。

### **第二步：使用测试接口**
在浏览器或Postman中访问：
```
POST http://8.136.43.180:8080/test/notification?operatorId=2&operatorRole=PURCHASER
```

**预期结果：**
- 返回："通知发送成功！请检查管理员是否收到通知。"
- 后端日志显示详细的通知发送过程

### **第三步：检查后端日志**
重启后端服务，然后创建采购订单，查看日志中是否出现：

#### **必须出现的日志：**
```
=== 开始创建采购订单 ===
=== 开始发送采购订单创建通知 ===
申请人角色: PURCHASER
开始查询角色ID为 1 的用户
找到 X 个角色ID为 1 的用户
找到用户：ID=1, 姓名=管理员, 角色ID=1, 状态=1
业务操作通知发送结果：接收人=管理员, 保存成功=true, 通知ID=XXX
=== 采购订单创建通知发送完成 ===
```

#### **如果出现警告：**
```
没有找到角色ID为 1 的启用用户！
```
说明数据库中没有管理员用户或管理员用户被禁用。

### **第四步：检查数据库**

#### **检查管理员用户：**
```sql
SELECT id, username, real_name, role_id, status 
FROM sys_user 
WHERE role_id = 1;
```

**预期结果：**
- 至少有一个用户，`role_id = 1`，`status = 1`

#### **检查通知记录：**
```sql
SELECT * FROM system_notification 
WHERE type = 'PURCHASE_OPERATION' 
ORDER BY create_time DESC 
LIMIT 10;
```

**预期结果：**
- 有新的通知记录
- `receiver_id` 是管理员的用户ID
- `sender_id` 是采购员的用户ID
- `type = 'PURCHASE_OPERATION'`

### **第五步：检查前端**

#### **检查通知API调用：**
在浏览器F12 Network标签中查看：
```
GET /notifications/unread-count?userId=1
GET /notifications/list?userId=1&current=1&size=50
```

#### **检查返回数据：**
通知列表应该包含新创建的通知。

---

## 🔧 可能的问题和解决方案

### **问题1：没有管理员用户**
**症状：** 日志显示"没有找到角色ID为 1 的启用用户！"

**解决方案：**
```sql
-- 检查是否有管理员用户
SELECT * FROM sys_user WHERE role_id = 1;

-- 如果没有，创建一个
INSERT INTO sys_user (username, password, real_name, role_id, status, create_time, update_time) 
VALUES ('admin', '$2a$10$encrypted_password', '系统管理员', 1, 1, NOW(), NOW());

-- 如果有但被禁用，启用它
UPDATE sys_user SET status = 1 WHERE role_id = 1;
```

### **问题2：角色ID不正确**
**症状：** 用户存在但角色ID不是1

**解决方案：**
```sql
-- 检查角色表
SELECT * FROM sys_role;

-- 更新用户角色
UPDATE sys_user SET role_id = 1 WHERE username = 'admin';
```

### **问题3：通知保存失败**
**症状：** 日志显示"保存成功=false"

**解决方案：**
- 检查数据库连接
- 检查`system_notification`表结构
- 检查是否有字段约束问题

### **问题4：前端不显示通知**
**症状：** 数据库有通知记录，但前端不显示

**解决方案：**
- 检查前端通知API是否正常调用
- 检查通知类型映射是否正确
- 强制刷新浏览器缓存（Ctrl+F5）

---

## 📊 调试检查清单

### **后端检查：**
- [ ] 服务已重启
- [ ] 日志显示"开始创建采购订单"
- [ ] 日志显示"申请人角色: PURCHASER"
- [ ] 日志显示"找到 X 个角色ID为 1 的用户"
- [ ] 日志显示"保存成功=true"
- [ ] 数据库中有新的通知记录

### **数据库检查：**
- [ ] 存在`role_id = 1`且`status = 1`的用户
- [ ] `system_notification`表有新记录
- [ ] 通知的`receiver_id`是管理员ID
- [ ] 通知的`type = 'PURCHASE_OPERATION'`

### **前端检查：**
- [ ] 通知API正常调用
- [ ] API返回包含新通知
- [ ] 通知图标正确显示
- [ ] 浏览器缓存已清除

---

## 🎯 下一步行动

1. **重启后端服务**
2. **使用测试接口验证通知系统**
3. **创建采购订单并检查日志**
4. **根据日志输出定位具体问题**
5. **按照对应的解决方案修复**

**如果按照这个调试指南还是无法解决问题，请提供具体的日志输出，我会进一步分析。** 🔍
