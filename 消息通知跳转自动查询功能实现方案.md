# 消息通知跳转自动查询功能实现方案

## 目标
点击消息通知后，不仅跳转到对应页面，还要自动查询并展示相关数据。

## 已完成的模块

### 1. 分类管理 ✅
- **前端**：添加了分类名称搜索框和路由参数监听
- **后端**：已支持 `categoryName` 参数
- **跳转参数**：`categoryName`

### 2. 供应商管理 ✅
- **前端**：添加了供应商名称、联系人、联系电话、地址搜索框和路由参数监听
- **后端**：添加了 `contactPerson`、`contactPhone`、`address` 参数支持
- **跳转参数**：`supplierName`

### 3. 库存管理 ✅（已有）
- **前端**：已有商品名称搜索和路由参数监听
- **跳转参数**：`productName`

## 需要完成的模块

### 4. 商品管理
**查询字段**：商品编码 (`productCode`)

**前端修改**：`supermarket-frontend/src/views/product/Product.vue`
```javascript
// 1. 导入 useRoute 和 watch
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()

// 2. 在 onMounted 前添加路由参数监听
const applyRouteParams = () => {
  if (route.query.productCode) {
    searchForm.value.productCode = route.query.productCode
  }
}

watch(() => route.query.productCode, () => {
  applyRouteParams()
  fetchData()
}, { immediate: false })

// 3. 修改 onMounted
onMounted(() => {
  applyRouteParams()
  fetchData()
  fetchCategories()
})
```

**后端**：已支持 `productCode` 参数

---

### 5. 客户管理
**查询字段**：客户名称 (`customerName`)

**前端修改**：`supermarket-frontend/src/views/customer/Customer.vue`
```javascript
// 1. 导入 useRoute 和 watch
import { ref, onMounted, watch } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()

// 2. 在 onMounted 前添加路由参数监听
const applyRouteParams = () => {
  if (route.query.customerName) {
    searchForm.value.customerName = route.query.customerName
  }
}

watch(() => route.query.customerName, () => {
  applyRouteParams()
  loadData()
}, { immediate: false })

// 3. 修改 onMounted
onMounted(() => {
  applyRouteParams()
  loadData()
})
```

**后端**：已支持 `customerName` 参数

---

### 6. 采购管理
**查询字段**：采购单号 (`orderNo`)

**前端修改**：`supermarket-frontend/src/views/purchase/Purchase.vue`
```javascript
// 1. 导入 useRoute 和 watch
import { ref, onMounted, watch } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()

// 2. 在 onMounted 前添加路由参数监听
const applyRouteParams = () => {
  if (route.query.orderNo) {
    searchForm.value.orderNo = route.query.orderNo
  }
}

watch(() => route.query.orderNo, () => {
  applyRouteParams()
  loadData()
}, { immediate: false })

// 3. 修改 onMounted
onMounted(() => {
  applyRouteParams()
  loadData()
})
```

**后端**：需要检查是否支持 `orderNo` 参数

---

### 7. 销售管理
**查询字段**：销售单号 (`orderNo`)

**前端修改**：`supermarket-frontend/src/views/sale/Sale.vue`
```javascript
// 1. 导入 useRoute 和 watch（可能已有）
import { ref, onMounted, watch } from 'vue'
import { useRoute } from 'vue-router'

const route = useRoute()

// 2. 在 onMounted 前添加路由参数监听
const applyRouteParams = () => {
  if (route.query.orderNo) {
    searchForm.value.orderNo = route.query.orderNo
  }
}

watch(() => route.query.orderNo, () => {
  applyRouteParams()
  loadData()
}, { immediate: false })

// 3. 修改 onMounted
onMounted(async () => {
  await loadCustomers()
  await loadProducts()
  applyRouteParams()
  await loadData()
})
```

**后端**：需要检查是否支持 `orderNo` 参数

---

## 消息通知跳转逻辑修改

**文件**：`supermarket-frontend/src/components/NotificationPanel.vue`

需要修改 `handleNotificationClick` 方法，根据不同的业务类型传递不同的查询参数：

```javascript
const handleNotificationClick = async (notification) => {
  try {
    // 标记为已读
    await notificationApi.markAsRead(notification.id)
    
    // 根据业务类型跳转并传递查询参数
    const routeMap = {
      'CATEGORY': {
        path: '/category',
        query: { categoryName: notification.relatedName }
      },
      'PRODUCT': {
        path: '/product',
        query: { productCode: notification.relatedCode || notification.relatedName }
      },
      'SUPPLIER': {
        path: '/supplier',
        query: { supplierName: notification.relatedName }
      },
      'CUSTOMER': {
        path: '/customer',
        query: { customerName: notification.relatedName }
      },
      'PURCHASE': {
        path: '/purchase',
        query: { orderNo: notification.relatedOrderNo || notification.relatedName }
      },
      'SALE': {
        path: '/sale',
        query: { orderNo: notification.relatedOrderNo || notification.relatedName }
      },
      'INVENTORY': {
        path: '/inventory',
        query: { productName: notification.relatedName }
      }
    }
    
    const route = routeMap[notification.businessType]
    if (route) {
      router.push(route)
    }
    
    // 刷新通知列表
    await loadNotifications()
  } catch (error) {
    console.error('处理通知失败', error)
  }
}
```

**注意**：需要确保后端返回的通知数据包含必要的字段：
- `relatedName`：相关名称（分类名、商品名、供应商名、客户名等）
- `relatedCode`：相关编码（商品编码）
- `relatedOrderNo`：相关单号（采购单号、销售单号）

---

## 实现步骤

1. ✅ 分类管理 - 完成
2. ✅ 供应商管理 - 完成
3. ⏳ 商品管理 - 添加路由参数监听
4. ⏳ 客户管理 - 添加路由参数监听
5. ⏳ 采购管理 - 添加路由参数监听
6. ⏳ 销售管理 - 添加路由参数监听
7. ✅ 库存管理 - 已有
8. ⏳ 修改消息通知跳转逻辑

---

## 测试建议

1. 创建/编辑/删除各类数据，触发消息通知
2. 点击消息通知，验证是否正确跳转
3. 验证页面是否自动查询并展示相关数据
4. 验证搜索条件是否正确填充
5. 验证数据是否正确高亮或定位

---

## 注意事项

1. 所有路由参数监听都使用 `{ immediate: false }`，避免初始化时重复加载
2. 在 `onMounted` 中先调用 `applyRouteParams()` 再调用 `loadData()`
3. 确保后端接口支持相应的查询参数
4. 消息通知数据结构需要包含足够的信息用于跳转和查询
