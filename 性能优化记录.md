# 超市管理系统性能优化记录

## 优化时间
2025-12-10

## 问题描述

### 1. 首页仪表盘"本年"数据加载超时
- **现象**：切换到"本年"视图时，请求超时（timeout of 10000ms exceeded）
- **影响**：用户无法查看年度销售趋势数据

### 2. 客户管理分页数据重复
- **现象**：第二页和第三页显示相同的客户数据（如"胡霞"）
- **影响**：用户无法正确浏览客户列表

### 3. 消息列表加载失败
- **现象**：每次刷新页面都报"系统异常，请联系管理员"
- **影响**：用户体验差，无法查看系统通知

## 优化方案

### 1. 前端请求超时优化

**文件**: `supermarket-frontend/src/utils/request.js`

**修改内容**:
```javascript
// 修改前
timeout: 10000

// 修改后
timeout: 30000 // 增加到30秒，避免统计查询超时
```

**原因**: 统计查询需要处理大量数据，10秒超时时间不够

---

### 2. 后端分类占比查询优化

**文件**: `supermarket-backend/src/main/java/com/supermarket/service/impl/StatisticsServiceImpl.java`

**优化点**:

#### 2.1 减少数据传输
```java
// 修改前：查询完整订单对象
List<SaleOrder> saleOrders = saleOrderMapper.selectList(...)

// 修改后：只查询订单ID
List<Long> orderIds = saleOrderMapper.selectList(
    new LambdaQueryWrapper<SaleOrder>()
        .select(SaleOrder::getId)  // 只查询ID字段
        ...
)
```

#### 2.2 批量加载数据，避免循环查询
```java
// 修改前：在循环中逐个查询商品和分类
for (SaleOrderItem item : orderItems) {
    Product product = productMapper.selectById(item.getProductId());
    Category category = categoryMapper.selectById(categoryId);
}

// 修改后：一次性加载所有数据到Map
List<Product> allProducts = productMapper.selectList(null);
Map<Long, Product> productMap = allProducts.stream()
    .collect(Collectors.toMap(Product::getId, p -> p));

List<Category> allCategories = categoryMapper.selectList(null);
Map<Long, String> categoryNameMap = allCategories.stream()
    .collect(Collectors.toMap(Category::getId, Category::getCategoryName));
```

#### 2.3 分批查询订单明细
```java
// 避免IN子句过长导致SQL错误
int batchSize = 1000;
for (int i = 0; i < orderIds.size(); i += batchSize) {
    List<Long> batchIds = orderIds.subList(i, Math.min(i + batchSize, orderIds.size()));
    List<SaleOrderItem> batchItems = saleOrderItemMapper.selectList(
        new LambdaQueryWrapper<SaleOrderItem>()
            .in(SaleOrderItem::getOrderId, batchIds)
    );
    allOrderItems.addAll(batchItems);
}
```

**性能提升**:
- 减少数据库查询次数：从 N+M 次减少到 3+ceil(N/1000) 次
- 减少网络传输：只传输必要的字段
- 避免SQL IN子句过长错误

---

### 3. 客户管理分页优化

**文件**: `supermarket-frontend/src/views/customer/Customer.vue`

**修改内容**:
```javascript
const loadData = async () => {
  try {
    console.log('加载客户数据 - 页码:', pageNum.value, '每页条数:', pageSize.value)
    const { data } = await customerApi.getList({...})
    console.log('返回数据:', data)
    // 确保每次都是新的数组，避免Vue的响应式缓存问题
    customerList.value = [...data.records]
    total.value = data.total
  } catch (error) {
    console.error('加载客户数据失败:', error)
    ElMessage.error('加载数据失败')
  }
}
```

**优化点**:
- 添加详细日志，方便排查问题
- 使用数组展开运算符创建新数组，避免Vue响应式缓存

---

### 4. 消息通知错误处理优化

**文件**: `supermarket-frontend/src/views/layout/Layout.vue`

**修改内容**:
```javascript
const fetchMessages = async () => {
  try {
    console.log('正在获取消息列表，用户ID:', userId)
    const res = await getNotifications({...})
    console.log('消息列表响应:', res)
    if (res.code === 200) {
      notifications.value = res.data.records || []
    } else {
      console.error('获取消息列表失败，响应码:', res.code, '消息:', res.message)
    }
  } catch (error) {
    console.error('获取消息列表异常:', error)
    console.error('错误详情:', error.response?.data || error.message)
    // 不要显示错误提示，避免影响用户体验
  }
}
```

**优化点**:
- 添加详细的错误日志
- 捕获异常但不显示错误提示，避免影响用户体验

---

## 测试步骤

### 1. 本地测试

#### 启动后端
```bash
cd d:\code\supermarket-system\supermarket-backend
mvn clean package -DskipTests
java -jar target\supermarket-backend-1.0.0.jar
```

#### 启动前端
```bash
cd d:\code\supermarket-system\supermarket-frontend
npm run dev
```

#### 访问系统
- 前端地址：http://localhost:3000
- 后端API：http://localhost:8080/api

### 2. 测试重点

#### 测试首页仪表盘
1. 登录系统
2. 切换到"本周"视图 - 应该快速加载
3. 切换到"本月"视图 - 应该快速加载
4. 切换到"本年"视图 - 应该在30秒内加载完成
5. 打开浏览器控制台，查看是否有错误

#### 测试客户管理分页
1. 打开客户管理页面
2. 按 F12 打开控制台
3. 翻到第2页、第3页、第4页
4. 查看控制台日志，确认每次翻页都加载了不同的数据
5. 检查是否还有数据重复的问题

#### 测试消息通知
1. 刷新页面
2. 查看控制台是否有"获取消息列表失败"的错误
3. 查看右上角消息图标是否正常显示未读数量

---

## 预期效果

### 性能指标
- **本周数据加载**: < 1秒
- **本月数据加载**: < 3秒
- **本年数据加载**: < 15秒（之前超时）

### 用户体验
- ✅ 首页仪表盘所有视图都能正常加载
- ✅ 客户管理分页数据不重复
- ✅ 消息通知正常显示，不报错

---

## 部署到服务器

### 1. 修改配置为服务器IP
```bash
# 后端配置
vim supermarket-backend/src/main/resources/application.yml
# 将 localhost 改为 8.136.43.180

# 前端配置
vim supermarket-frontend/vite.config.js
# 将 localhost 改为 8.136.43.180
```

### 2. 重新打包
```bash
# 后端
cd supermarket-backend
mvn clean package -DskipTests

# 前端
cd supermarket-frontend
npm run build
```

### 3. 上传到服务器
- 后端JAR: `target/supermarket-backend-1.0.0.jar`
- 前端dist: `dist/` 文件夹

### 4. 重启服务
```bash
# 停止旧的后端进程
ps aux | grep java
kill -9 <PID>

# 启动新的后端
nohup java -jar supermarket-backend-1.0.0.jar > app.log 2>&1 &

# 替换前端文件
cd /usr/share/nginx/html/
mv dist dist.old
# 上传新的dist文件夹

# 重启Nginx
systemctl restart nginx
```

---

## 注意事项

1. **数据库索引**: 确保 `sale_order` 表的 `create_time` 和 `status` 字段有索引
2. **内存配置**: 如果数据量特别大，可能需要增加JVM内存
3. **缓存策略**: 未来可以考虑对统计数据添加Redis缓存
4. **定期清理**: 建议定期归档历史订单数据

---

## 后续优化建议

### 短期优化
1. 为统计查询添加Redis缓存（缓存5分钟）
2. 添加数据库索引优化查询速度
3. 前端添加加载进度条，提升用户体验

### 长期优化
1. 引入ElasticSearch进行统计分析
2. 使用数据仓库存储历史数据
3. 实现增量统计，避免全量查询
