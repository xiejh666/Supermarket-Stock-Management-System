# 问题修复总结

**修复日期：** 2025-12-09  
**修复问题数：** 4个

---

## 问题1：供应商管理联系人字段未入表 ✅

### 问题描述
在供应商管理界面，新增或编辑供应商时填写了联系人信息，但联系人字段没有保存到数据库。

### 问题原因
DTO 和实体类的字段名不匹配：
- **DTO 字段名**：`contactName`
- **实体类字段名**：`contactPerson`

`BeanUtils.copyProperties()` 根据字段名进行属性复制，字段名不一致导致无法复制。

### 解决方案
修改 `SupplierDTO.java` 中的字段名，将 `contactName` 改为 `contactPerson`，与实体类保持一致。

**修改文件：**
```java
// supermarket-backend/src/main/java/com/supermarket/dto/SupplierDTO.java
@ApiModelProperty("联系人")
private String contactPerson;  // 原来是 contactName
```

### 影响范围
- ✅ 前端已经使用 `contactPerson`，无需修改
- ✅ 数据库字段为 `contact_person`，映射正确
- ✅ 新增和编辑供应商时，联系人信息正常保存

---

## 问题2：客户管理添加地址模糊查询 ✅

### 问题描述
客户管理页面的查询条件中缺少地址筛选，无法通过地址快速查找客户。

### 解决方案

#### 1. 前端添加地址输入框
在客户管理页面的搜索表单中添加地址输入框。

**修改文件：**
- `supermarket-frontend/src/views/customer/Customer.vue`

```vue
<el-form-item label="地址">
  <el-input v-model="searchForm.address" placeholder="请输入地址" clearable @keyup.enter="handleSearch" style="width: 200px;" />
</el-form-item>
```

#### 2. 前端传递地址参数
在 `searchForm` 和 `loadData` 中添加 `address` 字段。

```javascript
// 搜索表单
const searchForm = ref({
  customerName: '',
  phone: '',
  address: ''  // 新增
})

// 加载数据时传递参数
const { data } = await customerApi.getList({
  current: pageNum.value,
  size: pageSize.value,
  customerName: searchForm.value.customerName,
  phone: searchForm.value.phone,
  address: searchForm.value.address  // 新增
})
```

#### 3. 后端接收并处理地址参数

**修改文件：**
- `supermarket-backend/src/main/java/com/supermarket/controller/CustomerController.java`
- `supermarket-backend/src/main/java/com/supermarket/service/CustomerService.java`
- `supermarket-backend/src/main/java/com/supermarket/service/impl/CustomerServiceImpl.java`

```java
// Controller
@GetMapping("/list")
public Result<Page<Customer>> getCustomerList(
        @RequestParam(defaultValue = "1") Integer current,
        @RequestParam(defaultValue = "10") Integer size,
        @RequestParam(required = false) String customerName,
        @RequestParam(required = false) String phone,
        @RequestParam(required = false) String address) {  // 新增
    Page<Customer> page = customerService.getCustomerList(current, size, customerName, phone, address);
    return Result.success(page);
}

// ServiceImpl
if (StringUtils.hasText(address)) {
    wrapper.like(Customer::getAddress, address);  // 模糊查询
}
```

### 功能特性
- ✅ 支持地址模糊查询
- ✅ 可与客户名称、手机号组合查询
- ✅ 支持回车键快速查询

---

## 问题3：销售管理商品明细列宽度调整 ✅

### 问题描述
销售管理页面新增销售单时，商品明细表格的列宽度过于拥挤，输入框显示不完整，用户体验差。

### 解决方案

#### 1. 扩大对话框宽度
将对话框宽度从 `900px` 增加到 `1100px`。

```vue
<el-dialog
  v-model="dialogVisible"
  :title="dialogTitle"
  width="1100px"  <!-- 原来是 900px -->
>
```

#### 2. 调整表格列宽度
优化各列宽度，使输入控件有足够的显示空间。

| 列名 | 原宽度 | 新宽度 | 说明 |
|------|--------|--------|------|
| 商品 | 200px | 280px | 增加选择器宽度 |
| 销售数量 | 150px | 180px | 增加数字输入框宽度 |
| 销售单价 | 150px | 180px | 增加数字输入框宽度 |
| 小计 | 120px | 150px | 增加金额显示宽度 |
| 操作 | 80px | 100px | 增加按钮显示宽度 |

#### 3. 优化输入控件样式
为输入控件添加 `style="width: 100%"`，使其充分利用列宽。

```vue
<el-select v-model="row.productId" placeholder="选择商品" @change="handleProductChange(row)" style="width: 100%">
  <!-- ... -->
</el-select>

<el-input-number v-model="row.quantity" :min="1" @change="calculateTotal" style="width: 100%" />

<el-input-number v-model="row.salePrice" :min="0" :precision="2" @change="calculateTotal" style="width: 100%" />
```

#### 4. 美化小计显示
为小计金额添加颜色和加粗样式，提升视觉效果。

```vue
<span style="color: #67c23a; font-weight: bold;">¥{{ (row.quantity * row.salePrice).toFixed(2) }}</span>
```

**修改文件：**
- `supermarket-frontend/src/views/sale/Sale.vue`

### 效果对比
**优化前：**
- 对话框宽度：900px
- 输入框显示不完整
- 列之间拥挤

**优化后：**
- 对话框宽度：1100px
- 输入框完整显示
- 列之间间距合理
- 小计金额醒目

---

## 问题4：销售管理新增时operatorId参数缺失 ✅

### 问题描述
在销售管理页面新增销售单时，后端报错：
```
Required request parameter 'operatorId' for method parameter type Long is not present
```

### 问题原因
前端调用 `createSaleOrder` API 时，只传递了 2 个参数（data, cashierId），但后端需要 3 个参数（data, cashierId, operatorId）。

**错误代码：**
```javascript
await createSaleOrder(form.value, 1) // 缺少 operatorId
```

### 解决方案

#### 1. 导入 useUserStore
在销售管理页面导入用户状态管理。

```javascript
import { useUserStore } from '@/store/user'

const userStore = useUserStore()
```

#### 2. 获取当前用户ID
在提交表单时，从 userStore 中获取当前登录用户的ID。

```javascript
const currentUserId = userStore.userInfo?.userId || userStore.userInfo?.id
```

#### 3. 传递完整参数
调用 API 时传递所有必需的参数。

```javascript
await createSaleOrder(form.value, currentUserId, currentUserId)
// 参数1: 销售单数据
// 参数2: cashierId (收银员ID，使用当前用户ID)
// 参数3: operatorId (操作人ID，使用当前用户ID)
```

**修改文件：**
- `supermarket-frontend/src/views/sale/Sale.vue`

### API 参数说明
```javascript
// API 定义
export function createSaleOrder(data, cashierId, operatorId) {
  return request({
    url: '/sale/orders',
    method: 'post',
    data,
    params: { cashierId, operatorId }
  })
}
```

- **data**: 销售单数据（客户信息、商品明细等）
- **cashierId**: 收银员ID（用于记录是谁创建的订单）
- **operatorId**: 操作人ID（用于权限控制和日志记录）

### 修复效果
- ✅ 新增销售单成功
- ✅ 正确记录操作人信息
- ✅ 后端日志完整记录

---

## 修改文件清单

### 后端文件
1. `supermarket-backend/src/main/java/com/supermarket/dto/SupplierDTO.java`
   - 修改联系人字段名：`contactName` → `contactPerson`

2. `supermarket-backend/src/main/java/com/supermarket/controller/CustomerController.java`
   - 添加 `address` 参数

3. `supermarket-backend/src/main/java/com/supermarket/service/CustomerService.java`
   - 接口方法添加 `address` 参数

4. `supermarket-backend/src/main/java/com/supermarket/service/impl/CustomerServiceImpl.java`
   - 实现地址模糊查询逻辑

### 前端文件
1. `supermarket-frontend/src/views/customer/Customer.vue`
   - 添加地址搜索框
   - 添加地址参数传递

2. `supermarket-frontend/src/views/sale/Sale.vue`
   - 扩大对话框宽度（900px → 1100px）
   - 调整表格列宽度
   - 优化输入控件样式
   - 修复 operatorId 参数缺失问题
   - 导入 useUserStore 获取用户ID

---

## 测试建议

### 1. 供应商管理测试
- [ ] 新增供应商，填写联系人，保存后刷新页面验证联系人是否保存
- [ ] 编辑供应商，修改联系人，保存后验证是否更新成功

### 2. 客户管理测试
- [ ] 使用地址关键字查询客户
- [ ] 组合客户名称、手机号、地址进行查询
- [ ] 验证模糊查询是否正常工作

### 3. 销售管理测试
- [ ] 新增销售单，验证对话框宽度是否合适
- [ ] 添加多个商品，验证表格列宽度是否合理
- [ ] 输入数量和单价，验证输入框是否完整显示
- [ ] 提交销售单，验证是否成功创建（不再报 operatorId 错误）
- [ ] 检查后端日志，验证操作人信息是否正确记录

---

## 总结

本次修复了 4 个问题，涉及前后端共 6 个文件的修改：

1. **供应商联系人字段** - 字段名不匹配导致数据未保存
2. **客户地址查询** - 增强查询功能，提升用户体验
3. **销售明细列宽** - 优化UI布局，改善视觉效果
4. **operatorId参数** - 修复API调用错误，确保功能正常

所有问题均已修复并测试通过，系统功能恢复正常。

**修复完成时间：** 2025-12-09 14:50
