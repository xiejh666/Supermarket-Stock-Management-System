# 商品管理模块修复说明

## 修复的问题

### 1. 侧边栏子菜单显示问题
**问题描述**: 点击"商品管理"菜单时，下拉选项（分类管理和商品管理）显示空白。

**原因分析**: `el-sub-menu`的`index`属性设置为`"product"`，与子菜单项`el-menu-item`的`index="/product"`冲突，导致菜单展开异常。

**修复方案**:
- 将`el-sub-menu`的`index`从`"product"`改为`"product-menu"`，避免与路由路径冲突
- 文件位置: `supermarket-frontend/src/views/layout/Layout.vue`

### 2. 新增商品时零售价验证问题
**问题描述**: 设置了零售价，但新增时提示"零售价不能为空"。

**原因分析**: 
- 数据库表中字段名为`price`（售价）
- 前端使用的字段名为`retailPrice`
- 后端DTO和Entity没有正确映射这两个字段

**修复方案**:
1. **后端Entity** (`Product.java`):
   - 添加`retailPrice`字段（`@TableField(exist = false)`标记为非数据库字段）
   - 添加`imageUrl`字段（与`image`字段映射）
   - 添加`specification`字段（规格）

2. **后端DTO** (`ProductDTO.java`):
   - 添加`retailPrice`字段（与`price`字段映射）
   - 添加`imageUrl`字段（与`image`字段映射）
   - 添加`specification`字段
   - 添加`warningStock`字段

3. **后端Service** (`ProductServiceImpl.java`):
   - 在`getProductList`方法中，将查询结果的`price`映射到`retailPrice`
   - 在`createProduct`和`updateProduct`方法中，将DTO的`retailPrice`映射到Entity的`price`
   - 同样处理`imageUrl`和`image`的映射

4. **数据库迁移**:
   - 创建SQL脚本添加`specification`字段
   - 文件: `sql/add-product-specification.sql`

### 3. 商品列表不显示零售价
**问题描述**: 数据库中有零售价数据，但商品列表中不显示。

**原因分析**: 后端返回的数据中`price`字段没有映射到前端期望的`retailPrice`字段。

**修复方案**:
- 在`ProductServiceImpl.getProductList`方法中，遍历查询结果，将每条记录的`price`值赋给`retailPrice`
- 前端表格列定义已正确使用`retailPrice`字段

## 技术细节

### 字段说明
- **price**: 数据库中的零售价字段（售价）
- **cost_price**: 数据库中的成本价字段
- **specification**: 商品规格字段（如"500ml"、"1kg"等），需要执行SQL脚本添加

### 字段映射关系
```
数据库字段    <-> Entity字段      <-> DTO字段        <-> 前端字段
price        <-> price          <-> price/retailPrice <-> retailPrice
cost_price   <-> costPrice      <-> costPrice      <-> costPrice
image        <-> image          <-> image/imageUrl <-> imageUrl
specification<-> specification  <-> specification  <-> specification
```

**重要说明**：
- `price`字段在数据库中代表**零售价**（售价）
- `cost_price`字段代表**成本价**
- 前端统一使用`retailPrice`来表示零售价，后端Service层负责映射

### 关键代码修改

#### 1. Layout.vue (侧边栏菜单)
```vue
<el-sub-menu index="product-menu">  <!-- 改为 product-menu -->
  <template #title>
    <el-icon><Goods /></el-icon>
    <span>商品管理</span>
  </template>
  <el-menu-item index="/category">分类管理</el-menu-item>
  <el-menu-item index="/product">商品管理</el-menu-item>
</el-sub-menu>
```

#### 2. Product.java (实体类)
```java
@TableField("price")
private BigDecimal price;

// 零售价（与price字段映射，为了前端兼容性）
@TableField(exist = false)
private BigDecimal retailPrice;

@TableField("image")
private String image;

@TableField(exist = false)
private String imageUrl;

private String specification;
```

#### 3. ProductServiceImpl.java (服务层)
```java
// 查询时映射
result.getRecords().forEach(product -> {
    product.setRetailPrice(product.getPrice());
    product.setImageUrl(product.getImage());
});

// 保存时映射
if (dto.getRetailPrice() != null) {
    product.setPrice(dto.getRetailPrice());
}
if (dto.getImageUrl() != null) {
    product.setImage(dto.getImageUrl());
}
```

## 测试步骤

### 1. 测试侧边栏菜单
1. 登录系统
2. 点击左侧"商品管理"菜单
3. 确认能看到"分类管理"和"商品管理"两个子菜单项
4. 点击子菜单项能正常跳转

### 2. 测试新增商品
1. 进入商品管理页面
2. 点击"新增商品"按钮
3. 填写所有必填字段，包括零售价
4. 点击"确定"按钮
5. 确认能成功创建，不再提示"零售价不能为空"

### 3. 测试零售价显示
1. 进入商品管理页面
2. 查看商品列表
3. 确认"零售价"列正确显示数据
4. 确认零售价数值与数据库中的`price`字段一致

## 数据库迁移

### ⚠️ **重要：必须先执行此步骤**

在使用商品管理功能前，**必须先执行**以下SQL脚本添加规格字段：

**方式1：使用提供的SQL文件**
```bash
# 在MySQL客户端中执行
mysql -u root -p supermarket < sql/add-product-specification.sql
```

**方式2：手动执行SQL**
```sql
-- 为商品表添加规格字段
ALTER TABLE `product` ADD COLUMN `specification` VARCHAR(50) DEFAULT NULL COMMENT '规格' AFTER `unit`;

-- 验证字段是否添加成功
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = DATABASE() 
  AND TABLE_NAME = 'product' 
  AND COLUMN_NAME = 'specification';
```

### 执行步骤：
1. **备份数据库**（重要！）
2. 连接到MySQL数据库
3. 选择`supermarket`数据库：`USE supermarket;`
4. 执行上述SQL脚本
5. 验证字段添加成功
6. **重启后端服务**

### specification字段说明：
- **用途**: 存储商品规格信息
- **示例值**: "500ml"、"1kg"、"250g"、"12瓶/箱"等
- **数据类型**: VARCHAR(50)
- **是否必填**: 否（可为NULL）
- **前端展示**: 在商品列表的"规格"列中显示

## 注意事项

1. **字段映射**: 前端使用`retailPrice`和`imageUrl`，后端数据库使用`price`和`image`，需要在Service层进行映射
2. **验证规则**: 前端表单验证规则已更新，确保数值类型字段的验证
3. **向后兼容**: 保留了`price`和`image`字段，同时添加了`retailPrice`和`imageUrl`字段，确保系统的向后兼容性
4. **数据库迁移**: 需要执行SQL脚本添加`specification`字段

## 相关文件

### 后端文件
- `entity/Product.java` - 商品实体类
- `dto/ProductDTO.java` - 商品数据传输对象
- `service/impl/ProductServiceImpl.java` - 商品服务实现
- `sql/add-product-specification.sql` - 数据库迁移脚本

### 前端文件
- `views/layout/Layout.vue` - 布局组件（侧边栏菜单）
- `views/product/Product.vue` - 商品管理页面

## 完成状态

- [x] 修复侧边栏子菜单显示问题
- [x] 修复新增商品零售价验证问题
- [x] 修复商品列表零售价显示问题
- [x] 添加规格字段支持
- [x] 添加数据库迁移脚本
- [x] 更新表单验证规则
