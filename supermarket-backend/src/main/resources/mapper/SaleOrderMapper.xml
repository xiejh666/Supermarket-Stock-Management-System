<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.supermarket.mapper.SaleOrderMapper">

    <!-- 分页查询销售订单列表 -->
    <select id="selectSaleOrderPage" resultType="com.supermarket.vo.SaleOrderVO">
        SELECT 
            so.*,
            c.customer_name,
            u.real_name as cashier_name
        FROM sale_order so
        LEFT JOIN customer c ON so.customer_id = c.id
        LEFT JOIN sys_user u ON so.cashier_id = u.id
        <where>
            <if test="orderNo != null and orderNo != ''">
                AND so.order_no LIKE CONCAT('%', #{orderNo}, '%')
            </if>
            <if test="customerName != null and customerName != ''">
                AND c.customer_name LIKE CONCAT('%', #{customerName}, '%')
            </if>
            <if test="status != null">
                AND so.status = #{status}
            </if>
            <if test="startDate != null and startDate != ''">
                AND DATE(so.create_time) &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(so.create_time) &lt;= #{endDate}
            </if>
        </where>
        ORDER BY so.create_time DESC
    </select>

    <!-- 获取销售趋势数据 - 按天统计 -->
    <select id="getSalesTrendByDay" resultType="map">
        SELECT 
            order_date as date,
            DATE_FORMAT(order_date, '%m-%d') as label,
            ROUND(COALESCE(SUM(total_amount), 0), 2) as salesAmount,
            COUNT(*) as orderCount
        FROM (
            SELECT DATE(create_time) as order_date, total_amount
            FROM sale_order 
            WHERE status = 1 
              AND create_time BETWEEN #{startDate} AND #{endDate}
        ) t
        GROUP BY order_date
        ORDER BY order_date
    </select>

    <!-- 获取销售趋势数据 - 按月统计 -->
    <select id="getSalesTrendByMonth" resultType="map">
        SELECT 
            order_month as month,
            CONCAT(order_month, '月') as label,
            ROUND(COALESCE(SUM(total_amount), 0), 2) as salesAmount,
            COUNT(*) as orderCount
        FROM (
            SELECT MONTH(create_time) as order_month, total_amount
            FROM sale_order 
            WHERE status = 1 
              AND YEAR(create_time) = #{year}
              AND MONTH(create_time) &lt;= #{currentMonth}
        ) t
        GROUP BY order_month
        ORDER BY order_month
    </select>

</mapper>
