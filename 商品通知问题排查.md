# 🔍 商品通知问题排查指南

## 📋 问题描述
用户反馈：新增商品时，purchaser和cashier账号都没有收到消息提醒。

## 🔧 排查步骤

### **第一步：检查数据库中的用户角色**
```sql
-- 查看所有用户的角色分配
SELECT u.id, u.username, u.real_name, u.role_id, u.status, r.role_name
FROM sys_user u
LEFT JOIN sys_role r ON u.role_id = r.id
WHERE u.status = 1
ORDER BY u.role_id;
```

**预期结果：**
- 应该有角色ID为2的用户（采购员）
- 应该有角色ID为3的用户（营业员）
- 所有用户状态都应该是1（启用）

### **第二步：检查最近的商品操作通知记录**
```sql
-- 查看最近的商品操作通知
SELECT n.*, u.real_name as receiver_name, u.role_id
FROM system_notification n
LEFT JOIN sys_user u ON n.receiver_id = u.id
WHERE n.type = 'PRODUCT_OPERATION'
ORDER BY n.create_time DESC
LIMIT 10;
```

**预期结果：**
- 应该有最近创建商品的通知记录
- 应该有发送给角色ID为2和3的用户的通知

### **第三步：检查后端日志**
在后端日志中查找以下关键信息：

```
=== 开始发送商品创建通知 ===
商品ID: X, 操作人ID: Y, 商品名称: 商品名
操作人角色: ADMIN/PURCHASER/CASHIER
管理员操作，通知采购员和营业员
开始查询角色ID为 2 的用户
找到 X 个角色ID为 2 的用户
开始查询角色ID为 3 的用户
找到 X 个角色ID为 3 的用户
=== 商品创建通知发送完成 ===
```

### **第四步：检查前端API调用**
确认前端创建商品时是否传递了operatorId：

```javascript
// 检查浏览器开发者工具的Network面板
// 创建商品的请求应该包含operatorId参数
POST /products?operatorId=当前用户ID
```

---

## 🚨 可能的问题原因

### **1. 用户角色配置问题**
- purchaser账号的role_id不是2
- cashier账号的role_id不是3
- 用户状态不是1（被禁用）

### **2. 前端传参问题**
- 前端没有传递operatorId
- operatorId传递错误

### **3. 角色识别问题**
- getUserRole方法返回错误的角色
- 角色ID映射不正确

### **4. 通知服务问题**
- 通知服务注入失败
- 数据库连接问题

---

## 🛠️ 修复方案

### **方案一：检查用户角色配置**
```sql
-- 如果用户角色ID不正确，更新用户角色
UPDATE sys_user SET role_id = 2 WHERE username = 'purchaser用户名';
UPDATE sys_user SET role_id = 3 WHERE username = 'cashier用户名';

-- 如果用户被禁用，启用用户
UPDATE sys_user SET status = 1 WHERE username IN ('purchaser用户名', 'cashier用户名');
```

### **方案二：检查前端传参**
确认Product.vue中的handleSubmit方法是否正确传递operatorId：

```javascript
const currentUserId = userStore.userInfo?.userId || userStore.userInfo?.id
await createProduct(form, currentUserId)
```

### **方案三：重启服务**
- 重启后端服务
- 清除浏览器缓存
- 重新登录

---

## 🧪 测试验证

### **测试步骤：**
1. 使用管理员账号创建商品
2. 检查purchaser和cashier账号是否收到通知
3. 使用purchaser账号创建商品
4. 检查管理员和cashier账号是否收到通知
5. 使用cashier账号创建商品
6. 检查管理员和purchaser账号是否收到通知

### **验证SQL：**
```sql
-- 查看最新的通知记录
SELECT 
    n.title,
    n.content,
    n.type,
    u.real_name as receiver_name,
    u.role_id,
    n.create_time
FROM system_notification n
LEFT JOIN sys_user u ON n.receiver_id = u.id
WHERE n.type = 'PRODUCT_OPERATION'
AND n.create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
ORDER BY n.create_time DESC;
```

---

## 📞 联系支持

如果以上步骤都无法解决问题，请提供：
1. 数据库查询结果截图
2. 后端日志截图
3. 前端Network请求截图
4. 当前登录用户的角色信息

我将根据这些信息进一步诊断问题。
