# 通知问题排查指南

## 🔍 我已经添加的调试日志

我在代码中添加了详细的日志输出，现在你需要：

### 第一步：重启后端服务

**必须重启后端服务**，否则新添加的日志代码不会生效。

### 第二步：创建采购订单测试

1. 使用采购员账号登录前端
2. 创建一个采购订单
3. **立即查看后端控制台日志**

### 第三步：查看日志输出

在后端控制台中，你应该看到类似这样的日志：

```
准备发送采购审核通知，订单ID: 123, 申请人ID: 5
开始发送采购审核通知，订单ID: 123, 申请人ID: 5
采购订单信息: 订单号=PO20251127001, 总金额=1000.00
申请人信息: ID=5, 姓名=张三
通知保存结果: 成功, 通知ID: 1
采购审核通知发送成功
```

## 📋 可能的问题和解决方案

### 问题1：看不到任何日志

**原因：** 后端服务没有重启

**解决：** 重启后端服务

---

### 问题2：看到"准备发送"但没有"开始发送"

**原因：** `notificationService` 为 null（依赖注入失败）

**解决：** 检查后端启动日志，看是否有循环依赖错误

---

### 问题3：看到"开始发送"但报错"采购订单不存在"

**原因：** 订单ID传递错误

**解决：** 检查前端传递的参数

---

### 问题4：看到"通知保存结果: 失败"

**原因：** 数据库表字段不匹配或约束问题

**解决：** 
1. 检查数据库表结构
2. 执行以下SQL查看表结构：
```sql
DESC system_notification;
```

3. 确保表结构与实体类匹配

---

### 问题5：看到"通知保存结果: 成功"但前端没有显示

**原因：** 前端通知功能未实现或API未调用

**解决：** 需要修改前端Layout.vue，集成通知API

---

## 🧪 数据库验证

### 检查通知是否真的保存了

执行以下SQL：

```sql
USE supermarket;
SELECT * FROM system_notification ORDER BY create_time DESC LIMIT 5;
```

**预期结果：**
- 如果有数据，说明后端通知发送成功，问题在前端
- 如果没有数据，说明后端保存失败，查看日志错误

---

## 🔧 前端通知功能检查

### 检查前端是否调用了通知API

打开浏览器开发者工具（F12），切换到Network标签：

1. 使用管理员账号登录
2. 查看是否有以下请求：
   - `/notifications/unread-count?userId=xxx`
   - `/notifications/list?userId=xxx&current=1&size=50`

**如果没有这些请求：**
说明前端Layout.vue还没有集成通知功能，需要修改Layout.vue

---

## 📝 完整的排查流程

### 步骤1：重启后端
```bash
# 停止当前服务
# 重新启动后端服务
```

### 步骤2：创建测试数据
1. 采购员登录
2. 创建采购订单
3. **立即查看后端控制台**

### 步骤3：查看后端日志
- ✅ 看到"准备发送采购审核通知" → 调用成功
- ✅ 看到"开始发送采购审核通知" → 服务注入成功
- ✅ 看到"采购订单信息" → 订单查询成功
- ✅ 看到"申请人信息" → 用户查询成功
- ✅ 看到"通知保存结果: 成功" → 数据库保存成功

### 步骤4：查看数据库
```sql
SELECT * FROM system_notification ORDER BY create_time DESC LIMIT 5;
```

### 步骤5：检查前端
1. 管理员登录
2. F12打开开发者工具
3. 查看Network标签
4. 看是否有通知相关的API请求

---

## 🎯 根据日志判断问题

### 情况A：完全没有日志
→ **后端服务没有重启**

### 情况B：只有"准备发送"，没有"开始发送"
→ **notificationService注入失败，检查Spring启动日志**

### 情况C：有"开始发送"，但报错
→ **查看具体错误信息，可能是：**
- 订单不存在
- 用户不存在
- 数据库字段不匹配

### 情况D：显示"保存成功"，数据库有数据，但前端没显示
→ **前端Layout.vue未集成通知功能**

需要修改 `src/views/layout/Layout.vue`：
1. 导入通知API
2. 在mounted时调用获取未读数量
3. 定时刷新通知列表

---

## 🚀 下一步操作

1. **立即重启后端服务** ⚠️
2. **创建测试采购订单**
3. **查看后端控制台日志**
4. **把日志内容发给我**

我会根据日志内容帮你定位具体问题！

---

## 💡 临时测试方法

如果你想快速验证通知功能是否正常，可以直接访问后端API：

### 测试1：手动创建通知
```bash
# 使用Postman或curl发送POST请求
POST http://localhost:8080/notifications/test
```

### 测试2：查询通知列表
```bash
# 使用管理员ID查询
GET http://localhost:8080/notifications/list?userId=1&current=1&size=10
```

### 测试3：查询未读数量
```bash
GET http://localhost:8080/notifications/unread-count?userId=1
```

---

## 📞 需要你提供的信息

请重启后端，创建采购订单后，把以下信息发给我：

1. **后端控制台的完整日志**（从"准备发送"开始的所有日志）
2. **数据库查询结果**：
   ```sql
   SELECT * FROM system_notification ORDER BY create_time DESC LIMIT 5;
   ```
3. **浏览器Network标签的截图**（管理员登录后的API请求）

有了这些信息，我就能准确定位问题了！🎯
