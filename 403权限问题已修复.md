# 403 权限问题已修复 ✅

## 🔍 问题原因

**403 Forbidden** = 无权访问

**根本原因**：
- SecurityConfig 配置要求所有接口都需要认证
- 但**没有配置 JWT Token 验证过滤器**
- 导致即使登录成功，访问其他接口时也无法通过认证

---

## ✅ 已修复内容

### 1. 创建了 JWT 认证过滤器 ✅

**文件**：`supermarket-backend/src/main/java/com/supermarket/filter/JwtAuthenticationFilter.java`

**功能**：
- 从请求 Header 中提取 JWT Token
- 验证 Token 是否有效
- 解析 Token 获取用户信息和角色
- 将认证信息设置到 Spring Security 上下文中

### 2. 更新了 SecurityConfig ✅

**修改内容**：
- 注入 `JwtAuthenticationFilter`
- 将过滤器添加到 Security 过滤链中
- 在 `UsernamePasswordAuthenticationFilter` 之前执行

---

## 🚀 现在需要做的

### ⚠️ 重启后端（必须！）

新的过滤器只有重启后才会生效。

**在 IDEA 中**：
1. 停止后端
2. 重新运行 `SupermarketApplication.java`

**等待启动完成**：
```
Started SupermarketApplication in X.XXX seconds
```

---

## ✅ 然后测试

### 步骤 1：重新登录

访问：http://localhost:3000

输入：
- 用户名：`admin`
- 密码：`123456`

### 步骤 2：访问其他页面

点击左侧菜单：
- 供应商管理
- 商品管理
- 库存管理
- 等等

### 步骤 3：检查 Network

按 F12 → Network 标签，查看请求：

**应该看到**：
```
Request URL: http://localhost:3000/api/suppliers/list?pageNum=1&pageSize=10
Request Method: GET
Status Code: 200 OK ✅ (不再是 403)

Response Headers:
Authorization: Bearer eyJhbGc...（Token）

Response:
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [...],
    "total": 3
  }
}
```

---

## 📊 预期结果

登录后：
- ✅ 首页能看到统计数据
- ✅ 供应商管理能看到供应商列表
- ✅ 商品管理能看到商品列表
- ✅ 库存管理能看到库存数据
- ✅ 所有页面都有数据显示

---

## 🔧 如果还是 403

### 1. 检查 Token 是否存储

按 F12 → Application 标签 → Local Storage → http://localhost:3000

应该看到：
- `token`: "eyJhbGc..."
- `userInfo`: {"userId":1,...}

### 2. 检查请求 Header

按 F12 → Network → 点击任意请求 → Headers 标签

**Request Headers** 应该包含：
```
Authorization: Bearer eyJhbGc...
```

### 3. 查看后端日志

如果请求还是 403，查看后端控制台是否有错误。

---

## 📝 技术说明

### JWT 认证流程

```
1. 用户登录
   ↓
2. 后端验证用户名密码
   ↓
3. 生成 JWT Token
   ↓
4. 返回 Token 给前端
   ↓
5. 前端存储 Token 到 LocalStorage
   ↓
6. 前端每次请求都在 Header 中携带 Token
   Authorization: Bearer <token>
   ↓
7. JwtAuthenticationFilter 拦截请求
   ↓
8. 验证 Token 是否有效
   ↓
9. 解析 Token 获取用户信息
   ↓
10. 将认证信息设置到 SecurityContext
   ↓
11. 请求继续处理
   ↓
12. 返回数据
```

### Filter 执行顺序

```
Request
  ↓
CorsFilter (允许跨域)
  ↓
JwtAuthenticationFilter (验证 JWT) ← 新增
  ↓
UsernamePasswordAuthenticationFilter
  ↓
FilterSecurityInterceptor (权限验证)
  ↓
Controller
  ↓
Response
```

---

## 🎯 关键代码

### JwtAuthenticationFilter

```java
// 从请求中获取 Token
String token = getTokenFromRequest(request);

// 验证 Token
if (StringUtils.hasText(token) && jwtUtils.validateToken(token)) {
    // 解析 Token
    Claims claims = jwtUtils.getClaimsFromToken(token);
    String username = claims.get("username", String.class);
    String roleCode = claims.get("roleCode", String.class);
    
    // 创建认证对象并设置到上下文
    UsernamePasswordAuthenticationToken authentication = 
        new UsernamePasswordAuthenticationToken(username, null, authorities);
    SecurityContextHolder.getContext().setAuthentication(authentication);
}
```

### SecurityConfig

```java
http
    .authorizeRequests()
    .antMatchers("/auth/login").permitAll()  // 登录无需认证
    .anyRequest().authenticated()  // 其他需要认证
    .and()
    .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);  // 添加 JWT 过滤器
```

### 前端请求拦截器

```javascript
service.interceptors.request.use(config => {
    const token = getToken()
    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`  // 添加 Token
    }
    return config
})
```

---

## ✨ 总结

**问题**：登录成功但访问其他接口返回 403

**原因**：缺少 JWT Token 验证过滤器

**解决**：
1. ✅ 创建 `JwtAuthenticationFilter`
2. ✅ 在 `SecurityConfig` 中添加过滤器
3. ⚠️ **重启后端**

**结果**：所有接口都能正常访问，有数据显示

---

**现在请重启后端，然后重新登录测试！** 🚀

如果还有问题，请告诉我：
1. 浏览器 Console 的错误
2. Network 中请求的状态码
3. 后端控制台的日志


