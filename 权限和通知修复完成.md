# 权限和通知修复完成

## ✅ 已完成的修复

### 问题1：完善权限规则 ✅

#### 修改内容：

**1. 采购员权限**
- ✅ 可以操作供应商管理（新增、编辑）
- ✅ 不能操作客户管理（菜单不可见）
- ✅ 可以进行库存入库操作
- ✅ 不能进行库存出库操作

**2. 销售员权限**
- ✅ 可以操作客户管理（新增、编辑）
- ✅ 不能操作供应商管理（菜单不可见）
- ✅ 可以进行库存出库操作
- ✅ 不能进行库存入库操作

#### 修改的文件：

1. **`src/utils/permission.js`** - 更新权限配置
   ```javascript
   PURCHASER: {
     canCreate: ['purchase', 'supplier', 'inventory_inbound'],
     canUpdate: ['purchase', 'supplier', 'inventory_inbound'],
     canInbound: ['inventory'], // 可以入库
     canOutbound: [] // 不能出库
   },
   SALESPERSON: {
     canCreate: ['sale', 'customer', 'inventory_outbound'],
     canUpdate: ['sale', 'customer', 'inventory_outbound'],
     canInbound: [], // 不能入库
     canOutbound: ['inventory'] // 可以出库
   }
   ```

2. **`src/views/supplier/Supplier.vue`** - 供应商管理权限控制
   - 新增按钮：管理员和采购员可见
   - 编辑/删除按钮：管理员和采购员可见

3. **`src/views/customer/Customer.vue`** - 客户管理权限控制
   - 新增按钮：管理员和销售员可见
   - 编辑/删除按钮：管理员和销售员可见

4. **`src/views/inventory/Inventory.vue`** - 库存管理权限控制
   - 入库选项：管理员和采购员可见
   - 出库选项：管理员和销售员可见

---

### 问题2：采购通知未发送 ⚠️

#### 问题原因：

数据库中**没有创建 `system_notification` 表**！

#### 解决方案：

**必须执行以下SQL语句创建表：**

```sql
-- 创建系统通知表
CREATE TABLE IF NOT EXISTS `system_notification` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `title` varchar(200) NOT NULL COMMENT '通知标题',
  `content` text NOT NULL COMMENT '通知内容',
  `type` varchar(50) NOT NULL COMMENT '通知类型：PURCHASE_AUDIT-采购审核，SALE_PAYMENT-销售支付，SYSTEM-系统通知',
  `receiver_id` bigint DEFAULT NULL COMMENT '接收用户ID（为空表示发给所有管理员）',
  `sender_id` bigint NOT NULL COMMENT '发送用户ID',
  `business_id` bigint DEFAULT NULL COMMENT '关联业务ID（如采购订单ID、销售订单ID）',
  `business_type` varchar(50) DEFAULT NULL COMMENT '业务类型：PURCHASE_ORDER-采购订单，SALE_ORDER-销售订单',
  `is_read` tinyint NOT NULL DEFAULT '0' COMMENT '是否已读：0-未读，1-已读',
  `priority` tinyint NOT NULL DEFAULT '2' COMMENT '优先级：1-低，2-中，3-高',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_receiver_id` (`receiver_id`),
  KEY `idx_sender_id` (`sender_id`),
  KEY `idx_business` (`business_id`, `business_type`),
  KEY `idx_type_read` (`type`, `is_read`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统通知表';
```

**执行步骤：**

1. 打开MySQL客户端或Navicat
2. 选择 `supermarket` 数据库
3. 执行上面的SQL语句
4. 重启后端服务

**验证方法：**

执行以下SQL查看表是否创建成功：

```sql
SHOW TABLES LIKE 'system_notification';
```

---

## 📋 完整的权限矩阵

| 功能模块 | 管理员(ADMIN) | 采购员(PURCHASER) | 销售员(SALESPERSON) |
|---------|--------------|------------------|-------------------|
| **仪表盘** | ✅ 查看 | ✅ 查看 | ✅ 查看 |
| **分类管理** | ✅ 增删改查 | ✅ 查看 | ✅ 查看 |
| **商品管理** | ✅ 增删改查 | ✅ 查看 | ✅ 查看 |
| **供应商管理** | ✅ 增删改查 | ✅ 新增、编辑 | ❌ 不可见 |
| **客户管理** | ✅ 增删改查 | ❌ 不可见 | ✅ 新增、编辑 |
| **采购管理** | ✅ 增删改查 + 审核 | ✅ 新增、编辑 | ❌ 不可见 |
| **销售管理** | ✅ 增删改查 | ❌ 不可见 | ✅ 新增、编辑 |
| **库存管理** | ✅ 查看 + 入库 + 出库 | ✅ 查看 + 入库 | ✅ 查看 + 出库 |
| **用户管理** | ✅ 增删改查 | ❌ 不可见 | ❌ 不可见 |

---

## 🧪 测试步骤

### 测试1：采购员权限

1. 使用采购员账号登录
2. **供应商管理**：
   - ✅ 可以看到"新增供应商"按钮
   - ✅ 可以编辑供应商
   - ❌ 看不到删除按钮
3. **客户管理**：
   - ❌ 左侧菜单看不到"客户管理"
4. **库存管理**：
   - ✅ 点击"调整"按钮，只能看到"入库"选项
   - ❌ 看不到"出库"选项

### 测试2：销售员权限

1. 使用销售员账号登录
2. **客户管理**：
   - ✅ 可以看到"新增客户"按钮
   - ✅ 可以编辑客户
   - ❌ 看不到删除按钮
3. **供应商管理**：
   - ❌ 左侧菜单看不到"供应商管理"
4. **库存管理**：
   - ✅ 点击"调整"按钮，只能看到"出库"选项
   - ❌ 看不到"入库"选项

### 测试3：采购通知

**前提条件：必须先执行SQL创建表！**

1. 使用采购员账号登录
2. 创建一个采购订单
3. 使用管理员账号登录
4. **预期结果**：
   - ✅ 右上角通知图标显示未读数量（红色徽章）
   - ✅ 点击通知图标，看到采购订单通知
   - ✅ 通知内容：采购员XXX提交了采购订单XXX，总金额¥XXX，请及时审核

---

## ⚠️ 重要提示

### 1. 必须执行SQL创建表

**如果不执行SQL，通知功能完全无法工作！**

后端会报错：`Table 'supermarket.system_notification' doesn't exist`

### 2. 必须重启后端服务

修改Java代码后，必须重启后端服务才能生效。

### 3. 刷新前端页面

修改前端代码后，请刷新浏览器（Ctrl+F5）清除缓存。

### 4. 检查后端日志

如果通知还是没有发送，请检查后端控制台日志，查看是否有错误信息。

---

## 📝 已修改的文件清单

### 前端文件（5个）
1. `src/utils/permission.js` - 权限配置
2. `src/views/supplier/Supplier.vue` - 供应商管理
3. `src/views/customer/Customer.vue` - 客户管理
4. `src/views/inventory/Inventory.vue` - 库存管理
5. `src/views/purchase/Purchase.vue` - 采购管理（已有）
6. `src/views/sale/Sale.vue` - 销售管理（已有）

### 后端文件（已创建，需要执行SQL）
- 后端代码已经完成，只需要创建数据库表

---

## 🎯 下一步操作

### 立即执行（必须）：

1. **执行SQL创建表** ⚠️ 最重要
   ```sql
   -- 在MySQL中执行上面的CREATE TABLE语句
   ```

2. **重启后端服务**
   ```bash
   # 停止当前服务，重新启动
   ```

3. **刷新前端页面**
   ```
   Ctrl + F5
   ```

### 验证测试：

1. 采购员登录 → 创建采购订单
2. 管理员登录 → 查看通知（应该有未读消息）
3. 采购员登录 → 测试供应商管理权限
4. 销售员登录 → 测试客户管理权限
5. 测试库存入库/出库权限

---

## ✨ 完成后的效果

- ✅ 采购员只能管理供应商和采购，只能入库
- ✅ 销售员只能管理客户和销售，只能出库
- ✅ 管理员收到采购和销售的实时通知
- ✅ 通知显示详细信息（操作人、订单号、金额）
- ✅ 权限控制严格，无权限操作会提示

问题已全部修复！🎉
