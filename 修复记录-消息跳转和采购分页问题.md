# 消息跳转和采购分页问题修复记录

## 修复时间
2025-12-10

## 问题描述

### 问题1：消息跳转时采购单号错误
**现象**：
- 采购员收到消息："管理员 管理员11 新增了采购订单：PO202512101135066548，金额：¥9.00"
- 点击消息跳转到采购管理页面
- 实际查询的采购单号是 `730`，而不是 `PO202512101135066548`

**原因**：
- 前端使用了 `notification.businessId`（数据库ID）而不是 `notification.relatedCode`（订单号）
- `businessId` 是数据库主键ID（如730），`relatedCode` 才是订单号（如PO202512101135066548）

### 问题2：采购管理筛选后分页不正确
**现象**：
- 筛选供应商"立白"后，有很多条采购单
- 但每页只显示1条数据，而不是10条/页
- 需要翻很多页才能看到所有数据

**原因**：
- `loadData` 函数只加载了当前页的10条数据（后端分页）
- 前端筛选是在这10条数据上进行的
- 筛选后可能只有1条符合条件，所以每页只显示1条
- **正确做法**：应该加载所有数据，然后在前端进行筛选和分页

## 修复方案

### 修复1：消息跳转使用正确的订单号字段

**文件**：`supermarket-frontend/src/views/layout/Layout.vue`

**修改内容**：
```javascript
// 修改前
'PURCHASE_ORDER': {
  path: '/purchase',
  query: { orderNo: notification.businessId }, // ❌ 错误：使用数据库ID
  message: '已跳转到采购管理页面'
},

// 修改后
'PURCHASE_ORDER': {
  path: '/purchase',
  query: { orderNo: notification.relatedCode || notification.businessId }, // ✅ 正确：使用订单号
  message: '已跳转到采购管理页面'
},
```

**同时修复销售订单**：
```javascript
'SALE_ORDER': {
  path: '/sale',
  query: { orderNo: notification.relatedCode || notification.businessId },
  message: '已跳转到销售管理页面'
},
```

---

### 修复2：采购管理加载所有数据

**文件**：`supermarket-frontend/src/views/purchase/Purchase.vue`

#### 2.1 修改loadData函数 - 加载所有数据
```javascript
// 修改前
const loadData = async () => {
  try {
    const { data } = await purchaseApi.getList({
      current: pageNum.value,  // ❌ 使用当前页码
      size: pageSize.value      // ❌ 只加载10条
    })
    purchaseList.value = data.records
    total.value = data.total
    displayPurchaseList.value = data.records
    applyFilter()
  } catch (error) {
    ElMessage.error('加载数据失败')
  }
}

// 修改后
const loadData = async () => {
  try {
    // 加载所有数据，不分页（前端筛选需要所有数据）
    const { data } = await purchaseApi.getList({
      current: 1,
      size: 10000 // ✅ 获取所有数据
    })
    purchaseList.value = data.records
    total.value = data.total
    // 加载完数据后应用筛选条件（会自动分页）
    applyFilter()
  } catch (error) {
    ElMessage.error('加载数据失败')
  }
}
```

#### 2.2 优化applyRouteFilter函数 - 清除其他筛选条件
```javascript
// 应用订单号筛选（从消息通知跳转）
if (route.query.orderNo) {
  queryForm.orderNo = route.query.orderNo
  queryForm.status = null // 清除状态筛选
  queryForm.supplierName = '' // 清除供应商筛选
  queryForm.createTimeRange = null // 清除时间筛选
  queryForm.inboundTimeRange = null
  pageNum.value = 1 // 重置页码
}
```

---

## 数据流程说明

### 修复前的问题流程
```
1. 后端返回10条数据（第1页）
2. 前端筛选"立白" → 可能只有1条符合
3. 显示1条数据
4. 翻页 → 加载第2页的10条 → 筛选 → 又只有1条
```

### 修复后的正确流程
```
1. 后端返回所有数据（如100条）
2. 前端筛选"立白" → 找到15条符合
3. 前端分页：第1页显示前10条
4. 翻页 → 显示第2页的5条（剩余的5条）
```

---

## 修复效果

### 消息跳转
- ✅ 点击采购订单消息，正确跳转并查询对应的订单号
- ✅ 点击销售订单消息，正确跳转并查询对应的订单号
- ✅ 自动清除其他筛选条件，只显示目标订单

### 采购管理分页
- ✅ 筛选后每页显示10条数据（或设置的每页条数）
- ✅ 分页总数正确显示筛选后的数据量
- ✅ 翻页功能正常，可以查看所有筛选后的数据
- ✅ 无筛选时也正常显示所有数据并分页

---

## 测试步骤

### 测试消息跳转

1. **准备测试数据**
   - 用管理员账号创建一个采购订单
   - 记录订单号（如：PO202512101135066548）

2. **测试跳转**
   - 用采购员账号登录
   - 点击右上角消息图标
   - 找到采购订单通知
   - 点击消息
   - 验证：
     - 应该跳转到采购管理页面
     - 采购单号输入框应该自动填入完整订单号（PO202512101135066548）
     - 列表应该只显示这一条采购单

### 测试采购管理分页

1. **准备测试数据**
   - 确保数据库中有多个"立白"供应商的采购单（如15条）

2. **测试筛选和分页**
   - 登录系统
   - 进入采购管理页面
   - 在供应商输入框输入"立白"
   - 点击"查询"
   - 验证：
     - 应该显示"共15条"（或实际数量）
     - 第1页显示10条数据
     - 点击"下一页"，第2页显示5条数据
     - 每条数据的供应商都是"立白"

3. **测试其他筛选条件**
   - 测试按状态筛选
   - 测试按采购单号筛选
   - 测试组合筛选
   - 验证：所有筛选都应该正确分页显示

---

## 注意事项

### 性能考虑
- 当前方案是加载所有数据到前端（size=10000）
- 如果采购单数量超过10000条，需要考虑：
  1. 改用后端分页+筛选
  2. 增加size限制
  3. 添加数据量提示

### 后续优化建议
1. **短期优化**：将前端筛选改为后端筛选，提高性能
2. **长期优化**：实现虚拟滚动，支持大数据量展示

---

## 技术说明

### 通知数据结构
```javascript
{
  id: 123,
  businessId: 730,  // 数据库主键ID
  relatedCode: "PO202512101135066548",  // 订单号
  businessType: "PURCHASE_ORDER",
  content: "管理员 管理员11 新增了采购订单：PO202512101135066548，金额：¥9.00"
}
```

### 前端分页vs后端分页
- **后端分页**：适合大数据量，每次只加载当前页数据
- **前端分页**：适合小数据量+复杂筛选，一次加载所有数据

当前采购管理使用**前端分页+前端筛选**，所以需要一次性加载所有数据。
